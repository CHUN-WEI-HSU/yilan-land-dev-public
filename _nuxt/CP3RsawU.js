import{l as Et,c as S,d as et}from"./ejpV0U7u.js";import{T as _}from"./DENk7BAX.js";import{b as xt}from"./DCo6-o3V.js";import{T as Tt,E as lt,d as pt,l as It,u as nt}from"./DlQCJ7AR.js";import{y as Xt,u as N,j as ft,a as L,n as dt,z as Mt,A as vt,B as _t,C as ot,k as Wt,D as Yt,E as Lt,F as Ft,G as yt,H as wt,I as st,J as rt,o as Dt,K as z,g as J,L as Pt}from"./1jRA9jIJ.js";import{s as Ct,m as V,c as at}from"./Ba_gg6Bw.js";import{b as Ot}from"./JfErLOBA.js";class mt extends Tt{constructor(t,e,s){super(),s=s||{},this.tileCoord=t,this.state=e,this.key="",this.transition_=s.transition===void 0?250:s.transition,this.transitionStarts_={},this.interpolate=!!s.interpolate}changed(){this.dispatchEvent(lt.CHANGE)}release(){this.setState(_.EMPTY)}getKey(){return this.key+"/"+this.tileCoord}getTileCoord(){return this.tileCoord}getState(){return this.state}setState(t){if(this.state!==_.EMPTY){if(this.state!==_.ERROR&&this.state>t)throw new Error("Tile load sequence violation");this.state=t,this.changed()}}load(){pt()}getAlpha(t,e){if(!this.transition_)return 1;let s=this.transitionStarts_[t];if(!s)s=e,this.transitionStarts_[t]=s;else if(s===-1)return 1;const o=e-s+1e3/60;return o>=this.transition_?1:xt(o/this.transition_)}inTransition(t){return this.transition_?this.transitionStarts_[t]!==-1:!1}endTransition(t){this.transition_&&(this.transitionStarts_[t]=-1)}disposeInternal(){this.release(),super.disposeInternal()}}class Jt extends mt{constructor(t,e,s,o,i,h){super(t,e,h),this.crossOrigin_=o,this.src_=s,this.key=s,this.image_=new Image,o!==null&&(this.image_.crossOrigin=o),this.unlisten_=null,this.tileLoadFunction_=i}getImage(){return this.image_}setImage(t){this.image_=t,this.state=_.LOADED,this.unlistenImage_(),this.changed()}handleImageError_(){this.state=_.ERROR,this.unlistenImage_(),this.image_=At(),this.changed()}handleImageLoad_(){const t=this.image_;t.naturalWidth&&t.naturalHeight?this.state=_.LOADED:this.state=_.EMPTY,this.unlistenImage_(),this.changed()}load(){this.state==_.ERROR&&(this.state=_.IDLE,this.image_=new Image,this.crossOrigin_!==null&&(this.image_.crossOrigin=this.crossOrigin_)),this.state==_.IDLE&&(this.state=_.LOADING,this.changed(),this.tileLoadFunction_(this,this.src_),this.unlisten_=Et(this.image_,this.handleImageLoad_.bind(this),this.handleImageError_.bind(this)))}unlistenImage_(){this.unlisten_&&(this.unlisten_(),this.unlisten_=null)}disposeInternal(){this.unlistenImage_(),this.image_=null,super.disposeInternal()}}function At(){const n=S(1,1);return n.fillStyle="rgba(0,0,0,0)",n.fillRect(0,0,1,1),n.canvas}class Bt{constructor(t,e,s,o){this.minX=t,this.maxX=e,this.minY=s,this.maxY=o}contains(t){return this.containsXY(t[1],t[2])}containsTileRange(t){return this.minX<=t.minX&&t.maxX<=this.maxX&&this.minY<=t.minY&&t.maxY<=this.maxY}containsXY(t,e){return this.minX<=t&&t<=this.maxX&&this.minY<=e&&e<=this.maxY}equals(t){return this.minX==t.minX&&this.minY==t.minY&&this.maxX==t.maxX&&this.maxY==t.maxY}extend(t){t.minX<this.minX&&(this.minX=t.minX),t.maxX>this.maxX&&(this.maxX=t.maxX),t.minY<this.minY&&(this.minY=t.minY),t.maxY>this.maxY&&(this.maxY=t.maxY)}getHeight(){return this.maxY-this.minY+1}getSize(){return[this.getWidth(),this.getHeight()]}getWidth(){return this.maxX-this.minX+1}intersects(t){return this.minX<=t.maxX&&this.maxX>=t.minX&&this.minY<=t.maxY&&this.maxY>=t.minY}}function Vt(n,t,e,s,o){return o!==void 0?(o.minX=n,o.maxX=t,o.minY=e,o.maxY=s,o):new Bt(n,t,e,s)}let $;const R=[];function ht(n,t,e,s,o){n.beginPath(),n.moveTo(0,0),n.lineTo(t,e),n.lineTo(s,o),n.closePath(),n.save(),n.clip(),n.fillRect(0,0,Math.max(t,s)+1,Math.max(e,o)),n.restore()}function tt(n,t){return Math.abs(n[t*4]-210)>2||Math.abs(n[t*4+3]-.75*255)>2}function Gt(){if($===void 0){const n=S(6,6,R);n.globalCompositeOperation="lighter",n.fillStyle="rgba(210, 0, 0, 0.75)",ht(n,4,5,4,0),ht(n,4,5,0,5);const t=n.getImageData(0,0,3,3).data;$=tt(t,0)||tt(t,4)||tt(t,8),et(n),R.push(n.canvas)}return $}function ct(n,t,e,s){const o=_t(e,t,n);let i=ot(t,s,e);const h=t.getMetersPerUnit();h!==void 0&&(i*=h);const m=n.getMetersPerUnit();m!==void 0&&(i/=m);const g=n.getExtent();if(!g||Wt(g,o)){const T=ot(n,i,o)/i;isFinite(T)&&T>0&&(i/=T)}return i}function Rt(n,t,e,s){const o=Mt(e);let i=ct(n,t,o,s);return(!isFinite(i)||i<=0)&&vt(e,function(h){return i=ct(n,t,h,s),isFinite(i)&&i>0}),i}function kt(n,t,e,s,o,i,h,m,g,T,X,x,D,F){const a=S(Math.round(e*n),Math.round(e*t),R);if(x||(a.imageSmoothingEnabled=!1),g.length===0)return a.canvas;a.scale(e,e);function c(r){return Math.round(r*e)/e}a.globalCompositeOperation="lighter";const E=ft();g.forEach(function(r,y,C){Xt(E,r.extent)});let l;const f=e/s,d=(x?1:1+Math.pow(2,-24))/f;l=S(Math.round(L(E)*f),Math.round(N(E)*f),R),x||(l.imageSmoothingEnabled=!1),g.forEach(function(r,y,C){if(r.image.width>0&&r.image.height>0){if(r.clipExtent){l.save();const M=(r.clipExtent[0]-E[0])*f,v=-(r.clipExtent[3]-E[3])*f,w=L(r.clipExtent)*f,A=N(r.clipExtent)*f;l.rect(x?M:Math.round(M),x?v:Math.round(v),x?w:Math.round(M+w)-Math.round(M),x?A:Math.round(v+A)-Math.round(v)),l.clip()}const p=(r.extent[0]-E[0])*f,I=-(r.extent[3]-E[3])*f,W=L(r.extent)*f,Y=N(r.extent)*f;l.drawImage(r.image,T,T,r.image.width-2*T,r.image.height-2*T,x?p:Math.round(p),x?I:Math.round(I),x?W:Math.round(p+W)-Math.round(p),x?Y:Math.round(I+Y)-Math.round(I)),r.clipExtent&&l.restore()}});const u=dt(h);return m.getTriangles().forEach(function(r,y,C){const p=r.source,I=r.target;let W=p[0][0],Y=p[0][1],M=p[1][0],v=p[1][1],w=p[2][0],A=p[2][1];const k=c((I[0][0]-u[0])/i),Z=c(-(I[0][1]-u[1])/i),B=c((I[1][0]-u[0])/i),G=c(-(I[1][1]-u[1])/i),Q=c((I[2][0]-u[0])/i),j=c(-(I[2][1]-u[1])/i),U=W,q=Y;W=0,Y=0,M-=U,v-=q,w-=U,A-=q;const gt=[[M,v,0,0,B-k],[w,A,0,0,Q-k],[0,0,M,v,G-Z],[0,0,w,A,j-Z]],b=Ct(gt);if(!b)return;if(a.save(),a.beginPath(),Gt()||!x){a.moveTo(B,G);const P=4,K=k-B,it=Z-G;for(let O=0;O<P;O++)a.lineTo(B+c((O+1)*K/P),G+c(O*it/(P-1))),O!=P-1&&a.lineTo(B+c((O+1)*K/P),G+c((O+1)*it/(P-1)));a.lineTo(Q,j)}else a.moveTo(B,G),a.lineTo(k,Z),a.lineTo(Q,j);a.clip(),a.transform(b[0],b[2],b[1],b[3],k,Z),a.translate(E[0]-U,E[3]-q);let H;if(l)H=l.canvas,a.scale(d,-d);else{const P=g[0],K=P.extent;H=P.image,a.scale(L(K)/H.width,-N(K)/H.height)}a.drawImage(H,0,0),a.restore()}),l&&(et(l),R.push(l.canvas)),X&&(a.save(),a.globalCompositeOperation="source-over",a.strokeStyle="black",a.lineWidth=1,m.getTriangles().forEach(function(r,y,C){const p=r.target,I=(p[0][0]-u[0])/i,W=-(p[0][1]-u[1])/i,Y=(p[1][0]-u[0])/i,M=-(p[1][1]-u[1])/i,v=(p[2][0]-u[0])/i,w=-(p[2][1]-u[1])/i;a.beginPath(),a.moveTo(Y,M),a.lineTo(I,W),a.lineTo(v,w),a.closePath(),a.stroke()}),a.restore()),a.canvas}const Zt=10,ut=.25;class bt{constructor(t,e,s,o,i,h,m){this.sourceProj_=t,this.targetProj_=e;let g={};const T=m?Yt(d=>Ot(m,_t(d,this.targetProj_,this.sourceProj_))):Lt(this.targetProj_,this.sourceProj_);this.transformInv_=function(d){const u=d[0]+"/"+d[1];return g[u]||(g[u]=T(d)),g[u]},this.maxSourceExtent_=o,this.errorThresholdSquared_=i*i,this.triangles_=[],this.wrapsXInSource_=!1,this.canWrapXInSource_=this.sourceProj_.canWrapX()&&!!o&&!!this.sourceProj_.getExtent()&&L(o)>=L(this.sourceProj_.getExtent()),this.sourceWorldWidth_=this.sourceProj_.getExtent()?L(this.sourceProj_.getExtent()):null,this.targetWorldWidth_=this.targetProj_.getExtent()?L(this.targetProj_.getExtent()):null;const X=dt(s),x=Ft(s),D=yt(s),F=wt(s),a=this.transformInv_(X),c=this.transformInv_(x),E=this.transformInv_(D),l=this.transformInv_(F),f=Zt+(h?Math.max(0,Math.ceil(Math.log2(st(s)/(h*h*256*256)))):0);if(this.addQuad_(X,x,D,F,a,c,E,l,f),this.wrapsXInSource_){let d=1/0;this.triangles_.forEach(function(u,r,y){d=Math.min(d,u.source[0][0],u.source[1][0],u.source[2][0])}),this.triangles_.forEach(u=>{if(Math.max(u.source[0][0],u.source[1][0],u.source[2][0])-d>this.sourceWorldWidth_/2){const r=[[u.source[0][0],u.source[0][1]],[u.source[1][0],u.source[1][1]],[u.source[2][0],u.source[2][1]]];r[0][0]-d>this.sourceWorldWidth_/2&&(r[0][0]-=this.sourceWorldWidth_),r[1][0]-d>this.sourceWorldWidth_/2&&(r[1][0]-=this.sourceWorldWidth_),r[2][0]-d>this.sourceWorldWidth_/2&&(r[2][0]-=this.sourceWorldWidth_);const y=Math.min(r[0][0],r[1][0],r[2][0]);Math.max(r[0][0],r[1][0],r[2][0])-y<this.sourceWorldWidth_/2&&(u.source=r)}})}g={}}addTriangle_(t,e,s,o,i,h){this.triangles_.push({source:[o,i,h],target:[t,e,s]})}addQuad_(t,e,s,o,i,h,m,g,T){const X=rt([i,h,m,g]),x=this.sourceWorldWidth_?L(X)/this.sourceWorldWidth_:null,D=this.sourceWorldWidth_,F=this.sourceProj_.canWrapX()&&x>.5&&x<1;let a=!1;if(T>0){if(this.targetProj_.isGlobal()&&this.targetWorldWidth_){const E=rt([t,e,s,o]);a=L(E)/this.targetWorldWidth_>ut||a}!F&&this.sourceProj_.isGlobal()&&x&&(a=x>ut||a)}if(!a&&this.maxSourceExtent_&&isFinite(X[0])&&isFinite(X[1])&&isFinite(X[2])&&isFinite(X[3])&&!Dt(X,this.maxSourceExtent_))return;let c=0;if(!a&&(!isFinite(i[0])||!isFinite(i[1])||!isFinite(h[0])||!isFinite(h[1])||!isFinite(m[0])||!isFinite(m[1])||!isFinite(g[0])||!isFinite(g[1]))){if(T>0)a=!0;else if(c=(!isFinite(i[0])||!isFinite(i[1])?8:0)+(!isFinite(h[0])||!isFinite(h[1])?4:0)+(!isFinite(m[0])||!isFinite(m[1])?2:0)+(!isFinite(g[0])||!isFinite(g[1])?1:0),c!=1&&c!=2&&c!=4&&c!=8)return}if(T>0){if(!a){const E=[(t[0]+s[0])/2,(t[1]+s[1])/2],l=this.transformInv_(E);let f;F?f=(V(i[0],D)+V(m[0],D))/2-V(l[0],D):f=(i[0]+m[0])/2-l[0];const d=(i[1]+m[1])/2-l[1];a=f*f+d*d>this.errorThresholdSquared_}if(a){if(Math.abs(t[0]-s[0])<=Math.abs(t[1]-s[1])){const E=[(e[0]+s[0])/2,(e[1]+s[1])/2],l=this.transformInv_(E),f=[(o[0]+t[0])/2,(o[1]+t[1])/2],d=this.transformInv_(f);this.addQuad_(t,e,E,f,i,h,l,d,T-1),this.addQuad_(f,E,s,o,d,l,m,g,T-1)}else{const E=[(t[0]+e[0])/2,(t[1]+e[1])/2],l=this.transformInv_(E),f=[(s[0]+o[0])/2,(s[1]+o[1])/2],d=this.transformInv_(f);this.addQuad_(t,E,f,o,i,l,d,g,T-1),this.addQuad_(E,e,s,f,l,h,m,d,T-1)}return}}if(F){if(!this.canWrapXInSource_)return;this.wrapsXInSource_=!0}c&11||this.addTriangle_(t,s,o,i,m,g),c&14||this.addTriangle_(t,s,e,i,m,h),c&&(c&13||this.addTriangle_(e,o,t,h,g,i),c&7||this.addTriangle_(e,o,s,h,g,m))}calculateSourceExtent(){const t=ft();return this.triangles_.forEach(function(e,s,o){const i=e.source;z(t,i[0]),z(t,i[1]),z(t,i[2])}),t}getTriangles(){return this.triangles_}}const Ht=.5;class $t extends mt{constructor(t,e,s,o,i,h,m,g,T,X,x,D){super(i,_.IDLE,D),this.renderEdges_=x!==void 0?x:!1,this.pixelRatio_=m,this.gutter_=g,this.canvas_=null,this.sourceTileGrid_=e,this.targetTileGrid_=o,this.wrappedTileCoord_=h||i,this.sourceTiles_=[],this.sourcesListenerKeys_=null,this.sourceZ_=0,this.clipExtent_=t.canWrapX()?t.getExtent():void 0;const F=o.getTileCoordExtent(this.wrappedTileCoord_),a=this.targetTileGrid_.getExtent();let c=this.sourceTileGrid_.getExtent();const E=a?J(F,a):F;if(st(E)===0){this.state=_.EMPTY;return}const l=t.getExtent();l&&(c?c=J(c,l):c=l);const f=o.getResolution(this.wrappedTileCoord_[0]),d=Rt(t,s,E,f);if(!isFinite(d)||d<=0){this.state=_.EMPTY;return}const u=X!==void 0?X:Ht;if(this.triangulation_=new bt(t,s,E,c,d*u,f),this.triangulation_.getTriangles().length===0){this.state=_.EMPTY;return}this.sourceZ_=e.getZForResolution(d);let r=this.triangulation_.calculateSourceExtent();if(c&&(t.canWrapX()?(r[1]=at(r[1],c[1],c[3]),r[3]=at(r[3],c[1],c[3])):r=J(r,c)),!st(r))this.state=_.EMPTY;else{let y=0,C=0;t.canWrapX()&&(y=L(l),C=Math.floor((r[0]-l[0])/y)),Pt(r.slice(),t,!0).forEach(I=>{const W=e.getTileRangeForExtentAndZ(I,this.sourceZ_);for(let Y=W.minX;Y<=W.maxX;Y++)for(let M=W.minY;M<=W.maxY;M++){const v=T(this.sourceZ_,Y,M,m);if(v){const w=C*y;this.sourceTiles_.push({tile:v,offset:w})}}++C}),this.sourceTiles_.length===0&&(this.state=_.EMPTY)}}getImage(){return this.canvas_}reproject_(){const t=[];if(this.sourceTiles_.forEach(e=>{var o;const s=e.tile;if(s&&s.getState()==_.LOADED){const i=this.sourceTileGrid_.getTileCoordExtent(s.tileCoord);i[0]+=e.offset,i[2]+=e.offset;const h=(o=this.clipExtent_)==null?void 0:o.slice();h&&(h[0]+=e.offset,h[2]+=e.offset),t.push({extent:i,clipExtent:h,image:s.getImage()})}}),this.sourceTiles_.length=0,t.length===0)this.state=_.ERROR;else{const e=this.wrappedTileCoord_[0],s=this.targetTileGrid_.getTileSize(e),o=typeof s=="number"?s:s[0],i=typeof s=="number"?s:s[1],h=this.targetTileGrid_.getResolution(e),m=this.sourceTileGrid_.getResolution(this.sourceZ_),g=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_);this.canvas_=kt(o,i,this.pixelRatio_,m,this.sourceTileGrid_.getExtent(),h,g,this.triangulation_,t,this.gutter_,this.renderEdges_,this.interpolate),this.state=_.LOADED}this.changed()}load(){if(this.state==_.IDLE){this.state=_.LOADING,this.changed();let t=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(({tile:e})=>{const s=e.getState();if(s==_.IDLE||s==_.LOADING){t++;const o=It(e,lt.CHANGE,i=>{const h=e.getState();(h==_.LOADED||h==_.ERROR||h==_.EMPTY)&&(nt(o),t--,t===0&&(this.unlistenSources_(),this.reproject_()))});this.sourcesListenerKeys_.push(o)}}),t===0?setTimeout(this.reproject_.bind(this),0):this.sourceTiles_.forEach(function({tile:e},s,o){e.getState()==_.IDLE&&e.load()})}}unlistenSources_(){this.sourcesListenerKeys_.forEach(nt),this.sourcesListenerKeys_=null}release(){this.canvas_&&(et(this.canvas_.getContext("2d")),R.push(this.canvas_),this.canvas_=null),super.release()}}function ts(n,t,e,s){return s!==void 0?(s[0]=n,s[1]=t,s[2]=e,s):[n,t,e]}function ss(n,t,e){return n+"/"+t+"/"+e}function es(n){return Kt(n[0],n[1],n[2])}function Kt(n,t,e){return(t<<n)+e}function is(n,t){const e=n[0],s=n[1],o=n[2];if(t.getMinZoom()>e||e>t.getMaxZoom())return!1;const i=t.getFullTileRange(e);return i?i.containsXY(s,o):!0}export{Jt as I,$t as R,mt as T,Bt as a,Vt as b,ts as c,ss as g,es as h,is as w};
