import{g as l,c as g,f}from"./DGB6o809.js";import{I as s,a as u,b as I}from"./DYcbPNs3.js";import{T as C,E as d}from"./CBsAYBMq.js";class S{constructor(){this.cache_={},this.patternCache_={},this.cacheSize_=0,this.maxCacheSize_=1024}clear(){this.cache_={},this.patternCache_={},this.cacheSize_=0}canExpireCache(){return this.cacheSize_>this.maxCacheSize_}expire(){if(this.canExpireCache()){let t=0;for(const e in this.cache_){const a=this.cache_[e];!(t++&3)&&!a.hasListener()&&(delete this.cache_[e],delete this.patternCache_[e],--this.cacheSize_)}}}get(t,e,a){const i=m(t,e,a);return i in this.cache_?this.cache_[i]:null}getPattern(t,e,a){const i=m(t,e,a);return i in this.patternCache_?this.patternCache_[i]:null}set(t,e,a,i,r){const h=m(t,e,a),o=h in this.cache_;this.cache_[h]=i,r&&(i.getImageState()===s.IDLE&&i.load(),i.getImageState()===s.LOADING?i.ready().then(()=>{this.patternCache_[h]=l().createPattern(i.getImage(1),"repeat")}):this.patternCache_[h]=l().createPattern(i.getImage(1),"repeat")),o||++this.cacheSize_}setSize(t){this.maxCacheSize_=t,this.expire()}}function m(n,t,e){const a=e?u(e):"null";return t+":"+n+":"+a}const _=new S;let c=null;class E extends C{constructor(t,e,a,i,r){super(),this.hitDetectionImage_=null,this.image_=t,this.crossOrigin_=a,this.canvas_={},this.color_=r,this.imageState_=i===void 0?s.IDLE:i,this.size_=t&&t.width&&t.height?[t.width,t.height]:null,this.src_=e,this.tainted_,this.ready_=null}initializeImage_(){this.image_=new Image,this.crossOrigin_!==null&&(this.image_.crossOrigin=this.crossOrigin_)}isTainted_(){if(this.tainted_===void 0&&this.imageState_===s.LOADED){c||(c=g(1,1,void 0,{willReadFrequently:!0})),c.drawImage(this.image_,0,0);try{c.getImageData(0,0,1,1),this.tainted_=!1}catch{c=null,this.tainted_=!0}}return this.tainted_===!0}dispatchChangeEvent_(){this.dispatchEvent(d.CHANGE)}handleImageError_(){this.imageState_=s.ERROR,this.dispatchChangeEvent_()}handleImageLoad_(){this.imageState_=s.LOADED,this.size_=[this.image_.width,this.image_.height],this.dispatchChangeEvent_()}getImage(t){return this.image_||this.initializeImage_(),this.replaceColor_(t),this.canvas_[t]?this.canvas_[t]:this.image_}getPixelRatio(t){return this.replaceColor_(t),this.canvas_[t]?t:1}getImageState(){return this.imageState_}getHitDetectionImage(){if(this.image_||this.initializeImage_(),!this.hitDetectionImage_)if(this.isTainted_()){const t=this.size_[0],e=this.size_[1],a=g(t,e);a.fillRect(0,0,t,e),this.hitDetectionImage_=a.canvas}else this.hitDetectionImage_=this.image_;return this.hitDetectionImage_}getSize(){return this.size_}getSrc(){return this.src_}load(){if(this.imageState_===s.IDLE){this.image_||this.initializeImage_(),this.imageState_=s.LOADING;try{this.src_!==void 0&&(this.image_.src=this.src_)}catch{this.handleImageError_()}this.image_ instanceof HTMLImageElement&&f(this.image_,this.src_).then(t=>{this.image_=t,this.handleImageLoad_()}).catch(this.handleImageError_.bind(this))}}replaceColor_(t){if(!this.color_||this.canvas_[t]||this.imageState_!==s.LOADED)return;const e=this.image_,a=g(Math.ceil(e.width*t),Math.ceil(e.height*t)),i=a.canvas;a.scale(t,t),a.drawImage(e,0,0),a.globalCompositeOperation="multiply",a.fillStyle=I(this.color_),a.fillRect(0,0,i.width/t,i.height/t),a.globalCompositeOperation="destination-in",a.drawImage(e,0,0),this.canvas_[t]=i}ready(){return this.ready_||(this.ready_=new Promise(t=>{if(this.imageState_===s.LOADED||this.imageState_===s.ERROR)t();else{const e=()=>{(this.imageState_===s.LOADED||this.imageState_===s.ERROR)&&(this.removeEventListener(d.CHANGE,e),t())};this.addEventListener(d.CHANGE,e)}})),this.ready_}}function v(n,t,e,a,i,r){let h=t===void 0?void 0:_.get(t,e,i);return h||(h=new E(n,n&&"src"in n?n.src||void 0:t,e,a,i),_.set(t,e,i,h,r)),r&&h&&!_.getPattern(t,e,i)&&_.set(t,e,i,h,r),h}export{E as I,v as g,_ as s};
