var I=Object.defineProperty;var b=(l,e,t)=>e in l?I(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var y=(l,e,t)=>b(l,typeof e!="symbol"?e+"":e,t);import{b as p,E as D,e as L}from"./CBsAYBMq.js";import{I as c,a as x}from"./DYcbPNs3.js";import{g as R,c as v}from"./DGB6o809.js";import{n as P,F as w,G as M,H as S,a as K,u as A}from"./1jRA9jIJ.js";import{R as N,a as g}from"./C1H55nfk.js";import{a as m,e as O,b as d,c as _,m as k,t as F}from"./C3jLKcSw.js";import{a as z}from"./BBoprNr9.js";class H{constructor(){y(this,"pushMethodArgs_",(...e)=>(this.push_(e),this));this.instructions_=[],this.zIndex=0,this.offset_=0,this.context_=new Proxy(R(),{get:(e,t)=>{if(typeof R()[t]=="function")return this.push_(t),this.pushMethodArgs_},set:(e,t,n)=>(this.push_(t,n),!0)})}push_(...e){const t=this.instructions_,n=this.zIndex+this.offset_;t[n]||(t[n]=[]),t[n].push(...e)}pushFunction(e){this.push_(e)}getContext(){return this.context_}draw(e){this.instructions_.forEach(t=>{for(let n=0,a=t.length;n<a;++n){const s=t[n];if(typeof s=="function"){s(e);continue}const r=t[++n];if(typeof e[s]=="function")e[s](...r);else{if(typeof r=="function"){e[s]=r(e);continue}e[s]=r}}})}clear(){this.instructions_.length=0,this.zIndex=0,this.offset_=0}offset(){this.offset_=this.instructions_.length,this.zIndex=0}}const B=5;class q extends z{constructor(e){super(),this.ready=!0,this.boundHandleImageChange_=this.handleImageChange_.bind(this),this.layer_=e,this.staleKeys_=new Array,this.maxStaleKeys=B}getStaleKeys(){return this.staleKeys_}prependStaleKey(e){this.staleKeys_.unshift(e),this.staleKeys_.length>this.maxStaleKeys&&(this.staleKeys_.length=this.maxStaleKeys)}getFeatures(e){return p()}getData(e){return null}prepareFrame(e){return p()}renderFrame(e,t){return p()}forEachFeatureAtCoordinate(e,t,n,a,s){}getLayer(){return this.layer_}handleFontsChanged(){}handleImageChange_(e){const t=e.target;(t.getState()===c.LOADED||t.getState()===c.ERROR)&&this.renderIfReadyAndVisible()}loadImage(e){let t=e.getState();return t!=c.LOADED&&t!=c.ERROR&&e.addEventListener(D.CHANGE,this.boundHandleImageChange_),t==c.IDLE&&(e.load(),t=e.getState()),t==c.LOADED}renderIfReadyAndVisible(){const e=this.getLayer();e&&e.getVisible()&&e.getSourceState()==="ready"&&e.changed()}renderDeferred(e){}disposeInternal(){delete this.layer_,super.disposeInternal()}}const Y=[];let u=null;function V(){u=v(1,1,void 0,{willReadFrequently:!0})}class $ extends q{constructor(e){super(e),this.container=null,this.renderedResolution,this.tempTransform=m(),this.pixelTransform=m(),this.inversePixelTransform=m(),this.context=null,this.deferredContext_=null,this.containerReused=!1,this.frameState=null}getImageData(e,t,n){u||V(),u.clearRect(0,0,1,1);let a;try{u.drawImage(e,t,n,1,1,0,0,1,1),a=u.getImageData(0,0,1,1).data}catch{return u=null,null}return a}getBackground(e){let n=this.getLayer().getBackground();return typeof n=="function"&&(n=n(e.viewState.resolution)),n||void 0}useContainer(e,t,n){const a=this.getLayer().getClassName();let s,r;if(e&&e.className===a&&(!n||e&&e.style.backgroundColor&&L(x(e.style.backgroundColor),x(n)))){const i=e.firstElementChild;i instanceof HTMLCanvasElement&&(r=i.getContext("2d"))}if(r&&O(r.canvas.style.transform,t)?(this.container=e,this.context=r,this.containerReused=!0):this.containerReused?(this.container=null,this.context=null,this.containerReused=!1):this.container&&(this.container.style.backgroundColor=null),!this.container){s=document.createElement("div"),s.className=a;let i=s.style;i.position="absolute",i.width="100%",i.height="100%",r=v();const o=r.canvas;s.appendChild(o),i=o.style,i.position="absolute",i.left="0",i.transformOrigin="top left",this.container=s,this.context=r}!this.containerReused&&n&&!this.container.style.backgroundColor&&(this.container.style.backgroundColor=n)}clipUnrotated(e,t,n){const a=P(n),s=w(n),r=M(n),i=S(n);d(t.coordinateToPixelTransform,a),d(t.coordinateToPixelTransform,s),d(t.coordinateToPixelTransform,r),d(t.coordinateToPixelTransform,i);const o=this.inversePixelTransform;d(o,a),d(o,s),d(o,r),d(o,i),e.save(),e.beginPath(),e.moveTo(Math.round(a[0]),Math.round(a[1])),e.lineTo(Math.round(s[0]),Math.round(s[1])),e.lineTo(Math.round(r[0]),Math.round(r[1])),e.lineTo(Math.round(i[0]),Math.round(i[1])),e.clip()}prepareContainer(e,t){const n=e.extent,a=e.viewState.resolution,s=e.viewState.rotation,r=e.pixelRatio,i=Math.round(K(n)/a*r),o=Math.round(A(n)/a*r);_(this.pixelTransform,e.size[0]/2,e.size[1]/2,1/r,1/r,s,-i/2,-o/2),k(this.inversePixelTransform,this.pixelTransform);const f=F(this.pixelTransform);if(this.useContainer(t,f,this.getBackground(e)),!this.containerReused){const h=this.context.canvas;h.width!=i||h.height!=o?(h.width=i,h.height=o):this.context.clearRect(0,0,i,o),f!==h.style.transform&&(h.style.transform=f)}}dispatchRenderEvent_(e,t,n){const a=this.getLayer();if(a.hasListener(e)){const s=new N(e,this.inversePixelTransform,n,t);a.dispatchEvent(s)}}preRender(e,t){this.frameState=t,!t.declutter&&this.dispatchRenderEvent_(g.PRERENDER,e,t)}postRender(e,t){t.declutter||this.dispatchRenderEvent_(g.POSTRENDER,e,t)}renderDeferredInternal(e){}getRenderContext(e){return e.declutter&&!this.deferredContext_&&(this.deferredContext_=new H),e.declutter?this.deferredContext_.getContext():this.context}renderDeferred(e){e.declutter&&(this.dispatchRenderEvent_(g.PRERENDER,this.context,e),e.declutter&&this.deferredContext_&&(this.deferredContext_.draw(this.context),this.deferredContext_.clear()),this.renderDeferredInternal(e),this.dispatchRenderEvent_(g.POSTRENDER,this.context,e))}getRenderTransform(e,t,n,a,s,r,i){const o=s/2,f=r/2,h=a/t,C=-h,E=-e[0]+i,T=-e[1];return _(this.tempTransform,o,f,h,C,-n,E,T)}disposeInternal(){delete this.frameState,super.disposeInternal()}}export{$ as C,H as Z,Y as c};
