import{g as m,c as l,f as S,t as u}from"./ejpV0U7u.js";import{I as s,a as C,b as p}from"./jmR2vRPQ.js";import{T as D,E as o,d as n}from"./DlQCJ7AR.js";class y{constructor(){this.cache_={},this.patternCache_={},this.cacheSize_=0,this.maxCacheSize_=1024}clear(){this.cache_={},this.patternCache_={},this.cacheSize_=0}canExpireCache(){return this.cacheSize_>this.maxCacheSize_}expire(){if(this.canExpireCache()){let t=0;for(const e in this.cache_){const a=this.cache_[e];!(t++&3)&&!a.hasListener()&&(delete this.cache_[e],delete this.patternCache_[e],--this.cacheSize_)}}}get(t,e,a){const i=d(t,e,a);return i in this.cache_?this.cache_[i]:null}getPattern(t,e,a){const i=d(t,e,a);return i in this.patternCache_?this.patternCache_[i]:null}set(t,e,a,i,c){const h=d(t,e,a),I=h in this.cache_;this.cache_[h]=i,c&&(i.getImageState()===s.IDLE&&i.load(),i.getImageState()===s.LOADING?i.ready().then(()=>{this.patternCache_[h]=m().createPattern(i.getImage(1),"repeat")}):this.patternCache_[h]=m().createPattern(i.getImage(1),"repeat")),I||++this.cacheSize_}setSize(t){this.maxCacheSize_=t,this.expire()}}function d(r,t,e){const a=e?C(e):"null";return t+":"+r+":"+a}const g=new y;let _=null;class E extends D{constructor(t,e,a,i,c){super(),this.hitDetectionImage_=null,this.image_=t,this.crossOrigin_=a,this.canvas_={},this.color_=c,this.imageState_=i===void 0?s.IDLE:i,this.size_=t&&t.width&&t.height?[t.width,t.height]:null,this.src_=e,this.tainted_,this.ready_=null}initializeImage_(){this.image_=new Image,this.crossOrigin_!==null&&(this.image_.crossOrigin=this.crossOrigin_)}isTainted_(){if(this.tainted_===void 0&&this.imageState_===s.LOADED){_||(_=l(1,1,void 0,{willReadFrequently:!0})),_.drawImage(this.image_,0,0);try{_.getImageData(0,0,1,1),this.tainted_=!1}catch{_=null,this.tainted_=!0}}return this.tainted_===!0}dispatchChangeEvent_(){this.dispatchEvent(o.CHANGE)}handleImageError_(){this.imageState_=s.ERROR,this.dispatchChangeEvent_()}handleImageLoad_(){this.imageState_=s.LOADED,this.size_=[this.image_.width,this.image_.height],this.dispatchChangeEvent_()}getImage(t){return this.image_||this.initializeImage_(),this.replaceColor_(t),this.canvas_[t]?this.canvas_[t]:this.image_}getPixelRatio(t){return this.replaceColor_(t),this.canvas_[t]?t:1}getImageState(){return this.imageState_}getHitDetectionImage(){if(this.image_||this.initializeImage_(),!this.hitDetectionImage_)if(this.isTainted_()){const t=this.size_[0],e=this.size_[1],a=l(t,e);a.fillRect(0,0,t,e),this.hitDetectionImage_=a.canvas}else this.hitDetectionImage_=this.image_;return this.hitDetectionImage_}getSize(){return this.size_}getSrc(){return this.src_}load(){if(this.imageState_===s.IDLE){this.image_||this.initializeImage_(),this.imageState_=s.LOADING;try{this.src_!==void 0&&(this.image_.src=this.src_)}catch{this.handleImageError_()}this.image_ instanceof HTMLImageElement&&S(this.image_,this.src_).then(t=>{this.image_=t,this.handleImageLoad_()}).catch(this.handleImageError_.bind(this))}}replaceColor_(t){if(!this.color_||this.canvas_[t]||this.imageState_!==s.LOADED)return;const e=this.image_,a=l(Math.ceil(e.width*t),Math.ceil(e.height*t)),i=a.canvas;a.scale(t,t),a.drawImage(e,0,0),a.globalCompositeOperation="multiply",a.fillStyle=p(this.color_),a.fillRect(0,0,i.width/t,i.height/t),a.globalCompositeOperation="destination-in",a.drawImage(e,0,0),this.canvas_[t]=i}ready(){return this.ready_||(this.ready_=new Promise(t=>{if(this.imageState_===s.LOADED||this.imageState_===s.ERROR)t();else{const e=()=>{(this.imageState_===s.LOADED||this.imageState_===s.ERROR)&&(this.removeEventListener(o.CHANGE,e),t())};this.addEventListener(o.CHANGE,e)}})),this.ready_}}function A(r,t,e,a,i,c){let h=t===void 0?void 0:g.get(t,e,i);return h||(h=new E(r,r&&"src"in r?r.src||void 0:t,e,a,i),g.set(t,e,i,h,c)),c&&h&&!g.getPattern(t,e,i)&&g.set(t,e,i,h,c),h}class f{constructor(t){this.opacity_=t.opacity,this.rotateWithView_=t.rotateWithView,this.rotation_=t.rotation,this.scale_=t.scale,this.scaleArray_=u(t.scale),this.displacement_=t.displacement,this.declutterMode_=t.declutterMode}clone(){const t=this.getScale();return new f({opacity:this.getOpacity(),scale:Array.isArray(t)?t.slice():t,rotation:this.getRotation(),rotateWithView:this.getRotateWithView(),displacement:this.getDisplacement().slice(),declutterMode:this.getDeclutterMode()})}getOpacity(){return this.opacity_}getRotateWithView(){return this.rotateWithView_}getRotation(){return this.rotation_}getScale(){return this.scale_}getScaleArray(){return this.scaleArray_}getDisplacement(){return this.displacement_}getDeclutterMode(){return this.declutterMode_}getAnchor(){return n()}getImage(t){return n()}getHitDetectionImage(){return n()}getPixelRatio(t){return 1}getImageState(){return n()}getImageSize(){return n()}getOrigin(){return n()}getSize(){return n()}setDisplacement(t){this.displacement_=t}setOpacity(t){this.opacity_=t}setRotateWithView(t){this.rotateWithView_=t}setRotation(t){this.rotation_=t}setScale(t){this.scale_=t,this.scaleArray_=u(t)}listenImageChange(t){n()}load(){n()}unlistenImageChange(t){n()}ready(){return Promise.resolve()}}export{f as I,E as a,A as g,g as s};
