import{i as Ft,b as me,c as ye,a as bt}from"./Db2rOhY5.js";import{r as ze,e as Jt,g as Rt,d as At,h as Qe,j as $e}from"./CBsAYBMq.js";import{k as ie,N as ti,R as ei,d as ii,O as oe,o as et,p as Ce,j as Pt,K as ni,P as ne,Q as be,S as se,a as yt,u as si,m as oi,T as Mt,w as ri,U as li,V as ai}from"./1jRA9jIJ.js";import{c as vt,d as hi}from"./DGB6o809.js";import{a as Ie}from"./C1H55nfk.js";import{e as rt,f as Bt,g as it,h as nt,i as Gt,j as Yt,k as Xt,l as H,m as Nt,n as ht,o as Zt,p as kt,q as Me,r as ci,s as di,t as fi,u as Te}from"./BIaPAw8G.js";import{s as ui}from"./Cc173s93.js";import{l as V,t as gi,c as Re}from"./Ba_gg6Bw.js";import{r as _i,t as It}from"./CiY_2Xgg.js";import{a as jt,c as re,b as Ct,s as xi}from"./C3jLKcSw.js";import{Z as pi,C as Si,c as ke}from"./CviRnRtU.js";import{t as mi}from"./BAiuiMj1.js";import yi from"./_zC-pxp2.js";import{I as Tt}from"./DYcbPNs3.js";import{B as Ci}from"./BD0SBfHH.js";import"./BBoprNr9.js";import"./NcfOxGOJ.js";import"./DCo6-o3V.js";import"./BNCPP-Lc.js";import"./D391rXv1.js";import"./CKUT-AdB.js";import"./DSor2vHC.js";import"./MGqbFZfO.js";import"./DO_F0CpN.js";import"./jYV8uuws.js";import"./WJtrQfu8.js";class We{drawCustom(t,e,i,n,o){}drawGeometry(t){}setStyle(t){}drawCircle(t,e,i){}drawFeature(t,e,i){}drawGeometryCollection(t,e,i){}drawLineString(t,e,i){}drawMultiLineString(t,e,i){}drawMultiPoint(t,e,i){}drawMultiPolygon(t,e,i){}drawPoint(t,e,i){}drawPolygon(t,e,i){}drawText(t,e,i){}setFillStrokeStyle(t,e){}setImageStyle(t,e){}setTextStyle(t,e){}}const T={BEGIN_GEOMETRY:0,BEGIN_PATH:1,CIRCLE:2,CLOSE_PATH:3,CUSTOM:4,DRAW_CHARS:5,DRAW_IMAGE:6,END_GEOMETRY:7,FILL:8,MOVE_TO_LINE_TO:9,SET_FILL_STYLE:10,SET_STROKE_STYLE:11,STROKE:12},Wt=[T.FILL],lt=[T.STROKE],ct=[T.BEGIN_PATH],we=[T.CLOSE_PATH];class wt extends We{constructor(t,e,i,n){super(),this.tolerance=t,this.maxExtent=e,this.pixelRatio=n,this.maxLineWidth=0,this.resolution=i,this.beginGeometryInstruction1_=null,this.beginGeometryInstruction2_=null,this.bufferedMaxExtent_=null,this.instructions=[],this.coordinates=[],this.tmpCoordinate_=[],this.hitDetectionInstructions=[],this.state={}}applyPixelRatio(t){const e=this.pixelRatio;return e==1?t:t.map(function(i){return i*e})}appendFlatPointCoordinates(t,e){const i=this.getBufferedMaxExtent(),n=this.tmpCoordinate_,o=this.coordinates;let s=o.length;for(let r=0,l=t.length;r<l;r+=e)n[0]=t[r],n[1]=t[r+1],ie(i,n)&&(o[s++]=n[0],o[s++]=n[1]);return s}appendFlatLineCoordinates(t,e,i,n,o,s){const r=this.coordinates;let l=r.length;const h=this.getBufferedMaxExtent();s&&(e+=n);let a=t[e],c=t[e+1];const f=this.tmpCoordinate_;let d=!0,g,p,_;for(g=e+n;g<i;g+=n)f[0]=t[g],f[1]=t[g+1],_=ti(h,f),_!==p?(d&&(r[l++]=a,r[l++]=c,d=!1),r[l++]=f[0],r[l++]=f[1]):_===ei.INTERSECTING?(r[l++]=f[0],r[l++]=f[1],d=!1):d=!0,a=f[0],c=f[1],p=_;return(o&&d||g===e+n)&&(r[l++]=a,r[l++]=c),l}drawCustomCoordinates_(t,e,i,n,o){for(let s=0,r=i.length;s<r;++s){const l=i[s],h=this.appendFlatLineCoordinates(t,e,l,n,!1,!1);o.push(h),e=l}return e}drawCustom(t,e,i,n,o){this.beginGeometry(t,e,o);const s=t.getType(),r=t.getStride(),l=this.coordinates.length;let h,a,c,f,d;switch(s){case"MultiPolygon":h=t.getOrientedFlatCoordinates(),f=[];const g=t.getEndss();d=0;for(let p=0,_=g.length;p<_;++p){const x=[];d=this.drawCustomCoordinates_(h,d,g[p],r,x),f.push(x)}this.instructions.push([T.CUSTOM,l,f,t,i,ye,o]),this.hitDetectionInstructions.push([T.CUSTOM,l,f,t,n||i,ye,o]);break;case"Polygon":case"MultiLineString":c=[],h=s=="Polygon"?t.getOrientedFlatCoordinates():t.getFlatCoordinates(),d=this.drawCustomCoordinates_(h,0,t.getEnds(),r,c),this.instructions.push([T.CUSTOM,l,c,t,i,me,o]),this.hitDetectionInstructions.push([T.CUSTOM,l,c,t,n||i,me,o]);break;case"LineString":case"Circle":h=t.getFlatCoordinates(),a=this.appendFlatLineCoordinates(h,0,h.length,r,!1,!1),this.instructions.push([T.CUSTOM,l,a,t,i,Ft,o]),this.hitDetectionInstructions.push([T.CUSTOM,l,a,t,n||i,Ft,o]);break;case"MultiPoint":h=t.getFlatCoordinates(),a=this.appendFlatPointCoordinates(h,r),a>l&&(this.instructions.push([T.CUSTOM,l,a,t,i,Ft,o]),this.hitDetectionInstructions.push([T.CUSTOM,l,a,t,n||i,Ft,o]));break;case"Point":h=t.getFlatCoordinates(),this.coordinates.push(h[0],h[1]),a=this.coordinates.length,this.instructions.push([T.CUSTOM,l,a,t,i,void 0,o]),this.hitDetectionInstructions.push([T.CUSTOM,l,a,t,n||i,void 0,o]);break}this.endGeometry(e)}beginGeometry(t,e,i){this.beginGeometryInstruction1_=[T.BEGIN_GEOMETRY,e,0,t,i],this.instructions.push(this.beginGeometryInstruction1_),this.beginGeometryInstruction2_=[T.BEGIN_GEOMETRY,e,0,t,i],this.hitDetectionInstructions.push(this.beginGeometryInstruction2_)}finish(){return{instructions:this.instructions,hitDetectionInstructions:this.hitDetectionInstructions,coordinates:this.coordinates}}reverseHitDetectionInstructions(){const t=this.hitDetectionInstructions;t.reverse();let e;const i=t.length;let n,o,s=-1;for(e=0;e<i;++e)n=t[e],o=n[0],o==T.END_GEOMETRY?s=e:o==T.BEGIN_GEOMETRY&&(n[2]=e,ze(this.hitDetectionInstructions,s,e),s=-1)}fillStyleToState(t,e={}){if(t){const i=t.getColor();e.fillPatternScale=i&&typeof i=="object"&&"src"in i?this.pixelRatio:1,e.fillStyle=rt(i||H)}else e.fillStyle=void 0;return e}strokeStyleToState(t,e={}){if(t){const i=t.getColor();e.strokeStyle=rt(i||Nt);const n=t.getLineCap();e.lineCap=n!==void 0?n:Bt;const o=t.getLineDash();e.lineDash=o?o.slice():it;const s=t.getLineDashOffset();e.lineDashOffset=s||nt;const r=t.getLineJoin();e.lineJoin=r!==void 0?r:Gt;const l=t.getWidth();e.lineWidth=l!==void 0?l:Yt;const h=t.getMiterLimit();e.miterLimit=h!==void 0?h:Xt,e.lineWidth>this.maxLineWidth&&(this.maxLineWidth=e.lineWidth,this.bufferedMaxExtent_=null)}else e.strokeStyle=void 0,e.lineCap=void 0,e.lineDash=null,e.lineDashOffset=void 0,e.lineJoin=void 0,e.lineWidth=void 0,e.miterLimit=void 0;return e}setFillStrokeStyle(t,e){const i=this.state;this.fillStyleToState(t,i),this.strokeStyleToState(e,i)}createFill(t){const e=t.fillStyle,i=[T.SET_FILL_STYLE,e];return typeof e!="string"&&i.push(t.fillPatternScale),i}applyStroke(t){this.instructions.push(this.createStroke(t))}createStroke(t){return[T.SET_STROKE_STYLE,t.strokeStyle,t.lineWidth*this.pixelRatio,t.lineCap,t.lineJoin,t.miterLimit,t.lineDash?this.applyPixelRatio(t.lineDash):null,t.lineDashOffset*this.pixelRatio]}updateFillStyle(t,e){const i=t.fillStyle;(typeof i!="string"||t.currentFillStyle!=i)&&(i!==void 0&&this.instructions.push(e.call(this,t)),t.currentFillStyle=i)}updateStrokeStyle(t,e){const i=t.strokeStyle,n=t.lineCap,o=t.lineDash,s=t.lineDashOffset,r=t.lineJoin,l=t.lineWidth,h=t.miterLimit;(t.currentStrokeStyle!=i||t.currentLineCap!=n||o!=t.currentLineDash&&!Jt(t.currentLineDash,o)||t.currentLineDashOffset!=s||t.currentLineJoin!=r||t.currentLineWidth!=l||t.currentMiterLimit!=h)&&(i!==void 0&&e.call(this,t),t.currentStrokeStyle=i,t.currentLineCap=n,t.currentLineDash=o,t.currentLineDashOffset=s,t.currentLineJoin=r,t.currentLineWidth=l,t.currentMiterLimit=h)}endGeometry(t){this.beginGeometryInstruction1_[2]=this.instructions.length,this.beginGeometryInstruction1_=null,this.beginGeometryInstruction2_[2]=this.hitDetectionInstructions.length,this.beginGeometryInstruction2_=null;const e=[T.END_GEOMETRY,t];this.instructions.push(e),this.hitDetectionInstructions.push(e)}getBufferedMaxExtent(){if(!this.bufferedMaxExtent_&&(this.bufferedMaxExtent_=ii(this.maxExtent),this.maxLineWidth>0)){const t=this.resolution*(this.maxLineWidth+1)/2;oe(this.bufferedMaxExtent_,t,this.bufferedMaxExtent_)}return this.bufferedMaxExtent_}}class Ii extends wt{constructor(t,e,i,n){super(t,e,i,n),this.hitDetectionImage_=null,this.image_=null,this.imagePixelRatio_=void 0,this.anchorX_=void 0,this.anchorY_=void 0,this.height_=void 0,this.opacity_=void 0,this.originX_=void 0,this.originY_=void 0,this.rotateWithView_=void 0,this.rotation_=void 0,this.scale_=void 0,this.width_=void 0,this.declutterMode_=void 0,this.declutterImageWithText_=void 0}drawPoint(t,e,i){if(!this.image_||this.maxExtent&&!ie(this.maxExtent,t.getFlatCoordinates()))return;this.beginGeometry(t,e,i);const n=t.getFlatCoordinates(),o=t.getStride(),s=this.coordinates.length,r=this.appendFlatPointCoordinates(n,o);this.instructions.push([T.DRAW_IMAGE,s,r,this.image_,this.anchorX_*this.imagePixelRatio_,this.anchorY_*this.imagePixelRatio_,Math.ceil(this.height_*this.imagePixelRatio_),this.opacity_,this.originX_*this.imagePixelRatio_,this.originY_*this.imagePixelRatio_,this.rotateWithView_,this.rotation_,[this.scale_[0]*this.pixelRatio/this.imagePixelRatio_,this.scale_[1]*this.pixelRatio/this.imagePixelRatio_],Math.ceil(this.width_*this.imagePixelRatio_),this.declutterMode_,this.declutterImageWithText_]),this.hitDetectionInstructions.push([T.DRAW_IMAGE,s,r,this.hitDetectionImage_,this.anchorX_,this.anchorY_,this.height_,1,this.originX_,this.originY_,this.rotateWithView_,this.rotation_,this.scale_,this.width_,this.declutterMode_,this.declutterImageWithText_]),this.endGeometry(e)}drawMultiPoint(t,e,i){if(!this.image_)return;this.beginGeometry(t,e,i);const n=t.getFlatCoordinates(),o=[];for(let l=0,h=n.length;l<h;l+=t.getStride())(!this.maxExtent||ie(this.maxExtent,n.slice(l,l+2)))&&o.push(n[l],n[l+1]);const s=this.coordinates.length,r=this.appendFlatPointCoordinates(o,2);this.instructions.push([T.DRAW_IMAGE,s,r,this.image_,this.anchorX_*this.imagePixelRatio_,this.anchorY_*this.imagePixelRatio_,Math.ceil(this.height_*this.imagePixelRatio_),this.opacity_,this.originX_*this.imagePixelRatio_,this.originY_*this.imagePixelRatio_,this.rotateWithView_,this.rotation_,[this.scale_[0]*this.pixelRatio/this.imagePixelRatio_,this.scale_[1]*this.pixelRatio/this.imagePixelRatio_],Math.ceil(this.width_*this.imagePixelRatio_),this.declutterMode_,this.declutterImageWithText_]),this.hitDetectionInstructions.push([T.DRAW_IMAGE,s,r,this.hitDetectionImage_,this.anchorX_,this.anchorY_,this.height_,1,this.originX_,this.originY_,this.rotateWithView_,this.rotation_,this.scale_,this.width_,this.declutterMode_,this.declutterImageWithText_]),this.endGeometry(e)}finish(){return this.reverseHitDetectionInstructions(),this.anchorX_=void 0,this.anchorY_=void 0,this.hitDetectionImage_=null,this.image_=null,this.imagePixelRatio_=void 0,this.height_=void 0,this.scale_=void 0,this.opacity_=void 0,this.originX_=void 0,this.originY_=void 0,this.rotateWithView_=void 0,this.rotation_=void 0,this.width_=void 0,super.finish()}setImageStyle(t,e){const i=t.getAnchor(),n=t.getSize(),o=t.getOrigin();this.imagePixelRatio_=t.getPixelRatio(this.pixelRatio),this.anchorX_=i[0],this.anchorY_=i[1],this.hitDetectionImage_=t.getHitDetectionImage(),this.image_=t.getImage(this.pixelRatio),this.height_=n[1],this.opacity_=t.getOpacity(),this.originX_=o[0],this.originY_=o[1],this.rotateWithView_=t.getRotateWithView(),this.rotation_=t.getRotation(),this.scale_=t.getScaleArray(),this.width_=n[0],this.declutterMode_=t.getDeclutterMode(),this.declutterImageWithText_=e}}class Ti extends wt{constructor(t,e,i,n){super(t,e,i,n)}drawFlatCoordinates_(t,e,i,n){const o=this.coordinates.length,s=this.appendFlatLineCoordinates(t,e,i,n,!1,!1),r=[T.MOVE_TO_LINE_TO,o,s];return this.instructions.push(r),this.hitDetectionInstructions.push(r),i}drawLineString(t,e,i){const n=this.state,o=n.strokeStyle,s=n.lineWidth;if(o===void 0||s===void 0)return;this.updateStrokeStyle(n,this.applyStroke),this.beginGeometry(t,e,i),this.hitDetectionInstructions.push([T.SET_STROKE_STYLE,n.strokeStyle,n.lineWidth,n.lineCap,n.lineJoin,n.miterLimit,it,nt],ct);const r=t.getFlatCoordinates(),l=t.getStride();this.drawFlatCoordinates_(r,0,r.length,l),this.hitDetectionInstructions.push(lt),this.endGeometry(e)}drawMultiLineString(t,e,i){const n=this.state,o=n.strokeStyle,s=n.lineWidth;if(o===void 0||s===void 0)return;this.updateStrokeStyle(n,this.applyStroke),this.beginGeometry(t,e,i),this.hitDetectionInstructions.push([T.SET_STROKE_STYLE,n.strokeStyle,n.lineWidth,n.lineCap,n.lineJoin,n.miterLimit,it,nt],ct);const r=t.getEnds(),l=t.getFlatCoordinates(),h=t.getStride();let a=0;for(let c=0,f=r.length;c<f;++c)a=this.drawFlatCoordinates_(l,a,r[c],h);this.hitDetectionInstructions.push(lt),this.endGeometry(e)}finish(){const t=this.state;return t.lastStroke!=null&&t.lastStroke!=this.coordinates.length&&this.instructions.push(lt),this.reverseHitDetectionInstructions(),this.state=null,super.finish()}applyStroke(t){t.lastStroke!=null&&t.lastStroke!=this.coordinates.length&&(this.instructions.push(lt),t.lastStroke=this.coordinates.length),t.lastStroke=0,super.applyStroke(t),this.instructions.push(ct)}}class Le extends wt{constructor(t,e,i,n){super(t,e,i,n)}drawFlatCoordinatess_(t,e,i,n){const o=this.state,s=o.fillStyle!==void 0,r=o.strokeStyle!==void 0,l=i.length;this.instructions.push(ct),this.hitDetectionInstructions.push(ct);for(let h=0;h<l;++h){const a=i[h],c=this.coordinates.length,f=this.appendFlatLineCoordinates(t,e,a,n,!0,!r),d=[T.MOVE_TO_LINE_TO,c,f];this.instructions.push(d),this.hitDetectionInstructions.push(d),r&&(this.instructions.push(we),this.hitDetectionInstructions.push(we)),e=a}return s&&(this.instructions.push(Wt),this.hitDetectionInstructions.push(Wt)),r&&(this.instructions.push(lt),this.hitDetectionInstructions.push(lt)),e}drawCircle(t,e,i){const n=this.state,o=n.fillStyle,s=n.strokeStyle;if(o===void 0&&s===void 0)return;this.setFillStrokeStyles_(),this.beginGeometry(t,e,i),n.fillStyle!==void 0&&this.hitDetectionInstructions.push([T.SET_FILL_STYLE,H]),n.strokeStyle!==void 0&&this.hitDetectionInstructions.push([T.SET_STROKE_STYLE,n.strokeStyle,n.lineWidth,n.lineCap,n.lineJoin,n.miterLimit,it,nt]);const r=t.getFlatCoordinates(),l=t.getStride(),h=this.coordinates.length;this.appendFlatLineCoordinates(r,0,r.length,l,!1,!1);const a=[T.CIRCLE,h];this.instructions.push(ct,a),this.hitDetectionInstructions.push(ct,a),n.fillStyle!==void 0&&(this.instructions.push(Wt),this.hitDetectionInstructions.push(Wt)),n.strokeStyle!==void 0&&(this.instructions.push(lt),this.hitDetectionInstructions.push(lt)),this.endGeometry(e)}drawPolygon(t,e,i){const n=this.state,o=n.fillStyle,s=n.strokeStyle;if(o===void 0&&s===void 0)return;this.setFillStrokeStyles_(),this.beginGeometry(t,e,i),n.fillStyle!==void 0&&this.hitDetectionInstructions.push([T.SET_FILL_STYLE,H]),n.strokeStyle!==void 0&&this.hitDetectionInstructions.push([T.SET_STROKE_STYLE,n.strokeStyle,n.lineWidth,n.lineCap,n.lineJoin,n.miterLimit,it,nt]);const r=t.getEnds(),l=t.getOrientedFlatCoordinates(),h=t.getStride();this.drawFlatCoordinatess_(l,0,r,h),this.endGeometry(e)}drawMultiPolygon(t,e,i){const n=this.state,o=n.fillStyle,s=n.strokeStyle;if(o===void 0&&s===void 0)return;this.setFillStrokeStyles_(),this.beginGeometry(t,e,i),n.fillStyle!==void 0&&this.hitDetectionInstructions.push([T.SET_FILL_STYLE,H]),n.strokeStyle!==void 0&&this.hitDetectionInstructions.push([T.SET_STROKE_STYLE,n.strokeStyle,n.lineWidth,n.lineCap,n.lineJoin,n.miterLimit,it,nt]);const r=t.getEndss(),l=t.getOrientedFlatCoordinates(),h=t.getStride();let a=0;for(let c=0,f=r.length;c<f;++c)a=this.drawFlatCoordinatess_(l,a,r[c],h);this.endGeometry(e)}finish(){this.reverseHitDetectionInstructions(),this.state=null;const t=this.tolerance;if(t!==0){const e=this.coordinates;for(let i=0,n=e.length;i<n;++i)e[i]=ui(e[i],t)}return super.finish()}setFillStrokeStyles_(){const t=this.state;t.fillStyle!==void 0&&this.updateFillStyle(t,this.createFill),t.strokeStyle!==void 0&&this.updateStrokeStyle(t,this.applyStroke)}}function Ri(u,t,e,i,n){const o=[];let s=e,r=0,l=t.slice(e,2);for(;r<u&&s+n<i;){const[h,a]=l.slice(-2),c=t[s+n],f=t[s+n+1],d=Math.sqrt((c-h)*(c-h)+(f-a)*(f-a));if(r+=d,r>=u){const g=(u-r+d)/d,p=V(h,c,g),_=V(a,f,g);l.push(p,_),o.push(l),l=[p,_],r==u&&(s+=n),r=0}else if(r<u)l.push(t[s+n],t[s+n+1]),s+=n;else{const g=d-r,p=V(h,c,g/d),_=V(a,f,g/d);l.push(p,_),o.push(l),l=[p,_],r=0,s+=n}}return r>0&&o.push(l),o}function ki(u,t,e,i,n){let o=e,s=e,r=0,l=0,h=e,a,c,f,d,g,p,_,x,S,C;for(c=e;c<i;c+=n){const m=t[c],I=t[c+1];g!==void 0&&(S=m-g,C=I-p,d=Math.sqrt(S*S+C*C),_!==void 0&&(l+=f,a=Math.acos((_*S+x*C)/(f*d)),a>u&&(l>r&&(r=l,o=h,s=c),l=0,h=c-n)),f=d,_=S,x=C),g=m,p=I}return l+=d,l>r?[h,c]:[o,s]}const Ht={left:0,center:.5,right:1,top:0,middle:.5,hanging:.2,alphabetic:.8,ideographic:.8,bottom:1};class wi extends wt{constructor(t,e,i,n){super(t,e,i,n),this.labels_=null,this.text_="",this.textOffsetX_=0,this.textOffsetY_=0,this.textRotateWithView_=void 0,this.textKeepUpright_=void 0,this.textRotation_=0,this.textFillState_=null,this.fillStates={},this.fillStates[H]={fillStyle:H},this.textStrokeState_=null,this.strokeStates={},this.textState_={},this.textStates={},this.textKey_="",this.fillKey_="",this.strokeKey_="",this.declutterMode_=void 0,this.declutterImageWithText_=void 0}finish(){const t=super.finish();return t.textStates=this.textStates,t.fillStates=this.fillStates,t.strokeStates=this.strokeStates,t}drawText(t,e,i){const n=this.textFillState_,o=this.textStrokeState_,s=this.textState_;if(this.text_===""||!s||!n&&!o)return;const r=this.coordinates;let l=r.length;const h=t.getType();let a=null,c=t.getStride();if(s.placement==="line"&&(h=="LineString"||h=="MultiLineString"||h=="Polygon"||h=="MultiPolygon")){if(!et(this.maxExtent,t.getExtent()))return;let f;if(a=t.getFlatCoordinates(),h=="LineString")f=[a.length];else if(h=="MultiLineString")f=t.getEnds();else if(h=="Polygon")f=t.getEnds().slice(0,1);else if(h=="MultiPolygon"){const _=t.getEndss();f=[];for(let x=0,S=_.length;x<S;++x)f.push(_[x][0])}this.beginGeometry(t,e,i);const d=s.repeat,g=d?void 0:s.textAlign;let p=0;for(let _=0,x=f.length;_<x;++_){let S;d?S=Ri(d*this.resolution,a,p,f[_],c):S=[a.slice(p,f[_])];for(let C=0,m=S.length;C<m;++C){const I=S[C];let R=0,w=I.length;if(g==null){const L=ki(s.maxAngle,I,0,I.length,2);R=L[0],w=L[1]}for(let L=R;L<w;L+=c)r.push(I[L],I[L+1]);const E=r.length;p=f[_],this.drawChars_(l,E),l=E}}this.endGeometry(e)}else{let f=s.overflow?null:[];switch(h){case"Point":case"MultiPoint":a=t.getFlatCoordinates();break;case"LineString":a=t.getFlatMidpoint();break;case"Circle":a=t.getCenter();break;case"MultiLineString":a=t.getFlatMidpoints(),c=2;break;case"Polygon":a=t.getFlatInteriorPoint(),s.overflow||f.push(a[2]/this.resolution),c=3;break;case"MultiPolygon":const m=t.getFlatInteriorPoints();a=[];for(let I=0,R=m.length;I<R;I+=3)s.overflow||f.push(m[I+2]/this.resolution),a.push(m[I],m[I+1]);if(a.length===0)return;c=2;break}const d=this.appendFlatPointCoordinates(a,c);if(d===l)return;if(f&&(d-l)/2!==a.length/c){let m=l/2;f=f.filter((I,R)=>{const w=r[(m+R)*2]===a[R*c]&&r[(m+R)*2+1]===a[R*c+1];return w||--m,w})}this.saveTextStates_();const g=s.backgroundFill?this.createFill(this.fillStyleToState(s.backgroundFill)):null,p=s.backgroundStroke?this.createStroke(this.strokeStyleToState(s.backgroundStroke)):null;this.beginGeometry(t,e,i);let _=s.padding;if(_!=ht&&(s.scale[0]<0||s.scale[1]<0)){let m=s.padding[0],I=s.padding[1],R=s.padding[2],w=s.padding[3];s.scale[0]<0&&(I=-I,w=-w),s.scale[1]<0&&(m=-m,R=-R),_=[m,I,R,w]}const x=this.pixelRatio;this.instructions.push([T.DRAW_IMAGE,l,d,null,NaN,NaN,NaN,1,0,0,this.textRotateWithView_,this.textRotation_,[1,1],NaN,this.declutterMode_,this.declutterImageWithText_,_==ht?ht:_.map(function(m){return m*x}),g,p,this.text_,this.textKey_,this.strokeKey_,this.fillKey_,this.textOffsetX_,this.textOffsetY_,f]);const S=1/x,C=g?g.slice(0):null;C&&(C[1]=H),this.hitDetectionInstructions.push([T.DRAW_IMAGE,l,d,null,NaN,NaN,NaN,1,0,0,this.textRotateWithView_,this.textRotation_,[S,S],NaN,this.declutterMode_,this.declutterImageWithText_,_,C,p,this.text_,this.textKey_,this.strokeKey_,this.fillKey_?H:this.fillKey_,this.textOffsetX_,this.textOffsetY_,f]),this.endGeometry(e)}}saveTextStates_(){const t=this.textStrokeState_,e=this.textState_,i=this.textFillState_,n=this.strokeKey_;t&&(n in this.strokeStates||(this.strokeStates[n]={strokeStyle:t.strokeStyle,lineCap:t.lineCap,lineDashOffset:t.lineDashOffset,lineWidth:t.lineWidth,lineJoin:t.lineJoin,miterLimit:t.miterLimit,lineDash:t.lineDash}));const o=this.textKey_;o in this.textStates||(this.textStates[o]={font:e.font,textAlign:e.textAlign||kt,justify:e.justify,textBaseline:e.textBaseline||Zt,scale:e.scale});const s=this.fillKey_;i&&(s in this.fillStates||(this.fillStates[s]={fillStyle:i.fillStyle}))}drawChars_(t,e){const i=this.textStrokeState_,n=this.textState_,o=this.strokeKey_,s=this.textKey_,r=this.fillKey_;this.saveTextStates_();const l=this.pixelRatio,h=Ht[n.textBaseline],a=this.textOffsetY_*l,c=this.text_,f=i?i.lineWidth*Math.abs(n.scale[0])/2:0;this.instructions.push([T.DRAW_CHARS,t,e,h,n.overflow,r,n.maxAngle,l,a,o,f*l,c,s,1,this.declutterMode_,this.textKeepUpright_]),this.hitDetectionInstructions.push([T.DRAW_CHARS,t,e,h,n.overflow,r&&H,n.maxAngle,l,a,o,f*l,c,s,1/l,this.declutterMode_,this.textKeepUpright_])}setTextStyle(t,e){let i,n,o;if(!t)this.text_="";else{const s=t.getFill();s?(n=this.textFillState_,n||(n={},this.textFillState_=n),n.fillStyle=rt(s.getColor()||H)):(n=null,this.textFillState_=n);const r=t.getStroke();if(!r)o=null,this.textStrokeState_=o;else{o=this.textStrokeState_,o||(o={},this.textStrokeState_=o);const p=r.getLineDash(),_=r.getLineDashOffset(),x=r.getWidth(),S=r.getMiterLimit();o.lineCap=r.getLineCap()||Bt,o.lineDash=p?p.slice():it,o.lineDashOffset=_===void 0?nt:_,o.lineJoin=r.getLineJoin()||Gt,o.lineWidth=x===void 0?Yt:x,o.miterLimit=S===void 0?Xt:S,o.strokeStyle=rt(r.getColor()||Nt)}i=this.textState_;const l=t.getFont()||Me;ci(l);const h=t.getScaleArray();i.overflow=t.getOverflow(),i.font=l,i.maxAngle=t.getMaxAngle(),i.placement=t.getPlacement(),i.textAlign=t.getTextAlign(),i.repeat=t.getRepeat(),i.justify=t.getJustify(),i.textBaseline=t.getTextBaseline()||Zt,i.backgroundFill=t.getBackgroundFill(),i.backgroundStroke=t.getBackgroundStroke(),i.padding=t.getPadding()||ht,i.scale=h===void 0?[1,1]:h;const a=t.getOffsetX(),c=t.getOffsetY(),f=t.getRotateWithView(),d=t.getKeepUpright(),g=t.getRotation();this.text_=t.getText()||"",this.textOffsetX_=a===void 0?0:a,this.textOffsetY_=c===void 0?0:c,this.textRotateWithView_=f===void 0?!1:f,this.textKeepUpright_=d===void 0?!0:d,this.textRotation_=g===void 0?0:g,this.strokeKey_=o?(typeof o.strokeStyle=="string"?o.strokeStyle:Rt(o.strokeStyle))+o.lineCap+o.lineDashOffset+"|"+o.lineWidth+o.lineJoin+o.miterLimit+"["+o.lineDash.join()+"]":"",this.textKey_=i.font+i.scale+(i.textAlign||"?")+(i.repeat||"?")+(i.justify||"?")+(i.textBaseline||"?"),this.fillKey_=n&&n.fillStyle?typeof n.fillStyle=="string"?n.fillStyle:"|"+Rt(n.fillStyle):""}this.declutterMode_=t.getDeclutterMode(),this.declutterImageWithText_=e}}const Li={Circle:Le,Default:wt,Image:Ii,LineString:Ti,Polygon:Le,Text:wi};class Ei{constructor(t,e,i,n){this.tolerance_=t,this.maxExtent_=e,this.pixelRatio_=n,this.resolution_=i,this.buildersByZIndex_={}}finish(){const t={};for(const e in this.buildersByZIndex_){t[e]=t[e]||{};const i=this.buildersByZIndex_[e];for(const n in i){const o=i[n].finish();t[e][n]=o}}return t}getBuilder(t,e){const i=t!==void 0?t.toString():"0";let n=this.buildersByZIndex_[i];n===void 0&&(n={},this.buildersByZIndex_[i]=n);let o=n[e];if(o===void 0){const s=Li[e];o=new s(this.tolerance_,this.maxExtent_,this.resolution_,this.pixelRatio_),n[e]=o}return o}}function Di(u,t,e,i){let n=u[t],o=u[t+1],s=0;for(let r=t+i;r<e;r+=i){const l=u[r],h=u[r+1];s+=Math.sqrt((l-n)*(l-n)+(h-o)*(h-o)),n=l,o=h}return s}function Oi(u,t,e,i,n,o,s,r,l,h,a,c,f=!0){let d=u[t],g=u[t+1],p=0,_=0,x=0,S=0;function C(){p=d,_=g,t+=i,d=u[t],g=u[t+1],S+=x,x=Math.sqrt((d-p)*(d-p)+(g-_)*(g-_))}do C();while(t<e-i&&S+x<o);let m=x===0?0:(o-S)/x;const I=V(p,d,m),R=V(_,g,m),w=t-i,E=S,L=o+r*l(h,n,a);for(;t<e-i&&S+x<L;)C();m=x===0?0:(L-S)/x;const A=V(p,d,m),W=V(_,g,m);let D=!1;if(f)if(c){const k=[I,R,A,W];_i(k,0,4,2,c,k,k),D=k[0]>k[2]}else D=I>A;const M=Math.PI,P=[],O=w+i===t;t=w,x=0,S=E,d=u[t],g=u[t+1];let F;if(O){C(),F=Math.atan2(g-_,d-p),D&&(F+=F>0?-M:M);const k=(A+I)/2,b=(W+R)/2;return P[0]=[k,b,(L-o)/2,F,n],P}n=n.replace(/\n/g," ");for(let k=0,b=n.length;k<b;){C();let G=Math.atan2(g-_,d-p);if(D&&(G+=G>0?-M:M),F!==void 0){let J=G-F;if(J+=J>M?-2*M:J<-M?2*M:0,Math.abs(J)>s)return null}F=G;const v=k;let Y=0;for(;k<b;++k){const J=D?b-k-1:k,Lt=r*l(h,n[J],a);if(t+i<e&&S+x<o+Y+Lt/2)break;Y+=Lt}if(k===v)continue;const y=D?n.substring(b-v,b-k):n.substring(v,k);m=x===0?0:(o+Y/2-S)/x;const ut=V(p,d,m),gt=V(_,g,m);P.push([ut,gt,Y/2,G,y]),o+=Y}return P}const dt=Pt(),st=[],$=[],tt=[],ot=[];function Ee(u){return u[3].declutterBox}const De=new RegExp("[֑-ࣿיִ-﷿ﹰ-ﻼࠀ-࿿-]");function te(u,t){return t==="start"?t=De.test(u)?"right":"left":t==="end"&&(t=De.test(u)?"left":"right"),Ht[t]}function Fi(u,t,e){return e>0&&u.push(`
`,""),u.push(t,""),u}function bi(u,t,e){return e%2===0&&(u+=t),u}class Mi{constructor(t,e,i,n,o){this.overlaps=i,this.pixelRatio=e,this.resolution=t,this.alignAndScaleFill_,this.instructions=n.instructions,this.coordinates=n.coordinates,this.coordinateCache_={},this.renderedTransform_=jt(),this.hitDetectionInstructions=n.hitDetectionInstructions,this.pixelCoordinates_=null,this.viewRotation_=0,this.fillStates=n.fillStates||{},this.strokeStates=n.strokeStates||{},this.textStates=n.textStates||{},this.widths_={},this.labels_={},this.zIndexContext_=o?new pi:null}getZIndexContext(){return this.zIndexContext_}createLabel(t,e,i,n){const o=t+e+i+n;if(this.labels_[o])return this.labels_[o];const s=n?this.strokeStates[n]:null,r=i?this.fillStates[i]:null,l=this.textStates[e],h=this.pixelRatio,a=[l.scale[0]*h,l.scale[1]*h],c=l.justify?Ht[l.justify]:te(Array.isArray(t)?t[0]:t,l.textAlign||kt),f=n&&s.lineWidth?s.lineWidth:0,d=Array.isArray(t)?t:String(t).split(`
`).reduce(Fi,[]),{width:g,height:p,widths:_,heights:x,lineWidths:S}=di(l,d),C=g+f,m=[],I=(C+2)*a[0],R=(p+f)*a[1],w={width:I<0?Math.floor(I):Math.ceil(I),height:R<0?Math.floor(R):Math.ceil(R),contextInstructions:m};(a[0]!=1||a[1]!=1)&&m.push("scale",a),n&&(m.push("strokeStyle",s.strokeStyle),m.push("lineWidth",f),m.push("lineCap",s.lineCap),m.push("lineJoin",s.lineJoin),m.push("miterLimit",s.miterLimit),m.push("setLineDash",[s.lineDash]),m.push("lineDashOffset",s.lineDashOffset)),i&&m.push("fillStyle",r.fillStyle),m.push("textBaseline","middle"),m.push("textAlign","center");const E=.5-c;let L=c*C+E*f;const A=[],W=[];let D=0,M=0,P=0,O=0,F;for(let k=0,b=d.length;k<b;k+=2){const G=d[k];if(G===`
`){M+=D,D=0,L=c*C+E*f,++O;continue}const v=d[k+1]||l.font;v!==F&&(n&&A.push("font",v),i&&W.push("font",v),F=v),D=Math.max(D,x[P]);const Y=[G,L+E*_[P]+c*(_[P]-S[O]),.5*(f+D)+M];L+=_[P],n&&A.push("strokeText",Y),i&&W.push("fillText",Y),++P}return Array.prototype.push.apply(m,A),Array.prototype.push.apply(m,W),this.labels_[o]=w,w}replayTextBackground_(t,e,i,n,o,s,r){t.beginPath(),t.moveTo.apply(t,e),t.lineTo.apply(t,i),t.lineTo.apply(t,n),t.lineTo.apply(t,o),t.lineTo.apply(t,e),s&&(this.alignAndScaleFill_=s[2],t.fillStyle=s[1],this.fill_(t)),r&&(this.setStrokeStyle_(t,r),t.stroke())}calculateImageOrLabelDimensions_(t,e,i,n,o,s,r,l,h,a,c,f,d,g,p,_){r*=f[0],l*=f[1];let x=i-r,S=n-l;const C=o+h>t?t-h:o,m=s+a>e?e-a:s,I=g[3]+C*f[0]+g[1],R=g[0]+m*f[1]+g[2],w=x-g[3],E=S-g[0];(p||c!==0)&&(st[0]=w,ot[0]=w,st[1]=E,$[1]=E,$[0]=w+I,tt[0]=$[0],tt[1]=E+R,ot[1]=tt[1]);let L;return c!==0?(L=re(jt(),i,n,1,1,c,-i,-n),Ct(L,st),Ct(L,$),Ct(L,tt),Ct(L,ot),Ce(Math.min(st[0],$[0],tt[0],ot[0]),Math.min(st[1],$[1],tt[1],ot[1]),Math.max(st[0],$[0],tt[0],ot[0]),Math.max(st[1],$[1],tt[1],ot[1]),dt)):Ce(Math.min(w,w+I),Math.min(E,E+R),Math.max(w,w+I),Math.max(E,E+R),dt),d&&(x=Math.round(x),S=Math.round(S)),{drawImageX:x,drawImageY:S,drawImageW:C,drawImageH:m,originX:h,originY:a,declutterBox:{minX:dt[0],minY:dt[1],maxX:dt[2],maxY:dt[3],value:_},canvasTransform:L,scale:f}}replayImageOrLabel_(t,e,i,n,o,s,r){const l=!!(s||r),h=n.declutterBox,a=r?r[2]*n.scale[0]/2:0;return h.minX-a<=e[0]&&h.maxX+a>=0&&h.minY-a<=e[1]&&h.maxY+a>=0&&(l&&this.replayTextBackground_(t,st,$,tt,ot,s,r),fi(t,n.canvasTransform,o,i,n.originX,n.originY,n.drawImageW,n.drawImageH,n.drawImageX,n.drawImageY,n.scale)),!0}fill_(t){const e=this.alignAndScaleFill_;if(e){const i=Ct(this.renderedTransform_,[0,0]),n=512*this.pixelRatio;t.save(),t.translate(i[0]%n,i[1]%n),e!==1&&t.scale(e,e),t.rotate(this.viewRotation_)}t.fill(),e&&t.restore()}setStrokeStyle_(t,e){t.strokeStyle=e[1],t.lineWidth=e[2],t.lineCap=e[3],t.lineJoin=e[4],t.miterLimit=e[5],t.lineDashOffset=e[7],t.setLineDash(e[6])}drawLabelWithPointPlacement_(t,e,i,n){const o=this.textStates[e],s=this.createLabel(t,e,n,i),r=this.strokeStates[i],l=this.pixelRatio,h=te(Array.isArray(t)?t[0]:t,o.textAlign||kt),a=Ht[o.textBaseline||Zt],c=r&&r.lineWidth?r.lineWidth:0,f=s.width/l-2*o.scale[0],d=h*f+2*(.5-h)*c,g=a*s.height/l+2*(.5-a)*c;return{label:s,anchorX:d,anchorY:g}}execute_(t,e,i,n,o,s,r,l){const h=this.zIndexContext_;let a;this.pixelCoordinates_&&Jt(i,this.renderedTransform_)?a=this.pixelCoordinates_:(this.pixelCoordinates_||(this.pixelCoordinates_=[]),a=It(this.coordinates,0,this.coordinates.length,2,i,this.pixelCoordinates_),xi(this.renderedTransform_,i));let c=0;const f=n.length;let d=0,g,p,_,x,S,C,m,I,R,w,E,L,A,W=0,D=0;const M=this.coordinateCache_,P=this.viewRotation_,O=Math.round(Math.atan2(-i[1],i[0])*1e12)/1e12,F={context:t,pixelRatio:this.pixelRatio,resolution:this.resolution,rotation:P},k=this.instructions!=n||this.overlaps?0:200;let b,G,v,Y;for(;c<f;){const y=n[c];switch(y[0]){case T.BEGIN_GEOMETRY:b=y[1],Y=y[3],b.getGeometry()?r!==void 0&&!et(r,Y.getExtent())?c=y[2]+1:++c:c=y[2],h&&(h.zIndex=y[4]);break;case T.BEGIN_PATH:W>k&&(this.fill_(t),W=0),D>k&&(t.stroke(),D=0),!W&&!D&&(t.beginPath(),S=NaN,C=NaN),++c;break;case T.CIRCLE:d=y[1];const gt=a[d],J=a[d+1],Lt=a[d+2],Ge=a[d+3],le=Lt-gt,ae=Ge-J,he=Math.sqrt(le*le+ae*ae);t.moveTo(gt+he,J),t.arc(gt,J,he,0,2*Math.PI,!0),++c;break;case T.CLOSE_PATH:t.closePath(),++c;break;case T.CUSTOM:d=y[1],g=y[2];const Ye=y[3],Xe=y[4],ce=y[5];F.geometry=Ye,F.feature=b,c in M||(M[c]=[]);const _t=M[c];ce?ce(a,d,g,2,_t):(_t[0]=a[d],_t[1]=a[d+1],_t.length=2),h&&(h.zIndex=y[6]),Xe(_t,F),++c;break;case T.DRAW_IMAGE:d=y[1],g=y[2],R=y[3],p=y[4],_=y[5];let Kt=y[6];const Ne=y[7],Ze=y[8],je=y[9],de=y[10];let Vt=y[11];const He=y[12];let Et=y[13];x=y[14]||"declutter";const xt=y[15];if(!R&&y.length>=20){w=y[19],E=y[20],L=y[21],A=y[22];const N=this.drawLabelWithPointPlacement_(w,E,L,A);R=N.label,y[3]=R;const at=y[23];p=(N.anchorX-at)*this.pixelRatio,y[4]=p;const Z=y[24];_=(N.anchorY-Z)*this.pixelRatio,y[5]=_,Kt=R.height,y[6]=Kt,Et=R.width,y[13]=Et}let Ut;y.length>25&&(Ut=y[25]);let qt,Dt,Ot;y.length>17?(qt=y[16],Dt=y[17],Ot=y[18]):(qt=ht,Dt=null,Ot=null),de&&O?Vt+=P:!de&&!O&&(Vt-=P);let Je=0;for(;d<g;d+=2){if(Ut&&Ut[Je++]<Et/this.pixelRatio)continue;const N=this.calculateImageOrLabelDimensions_(R.width,R.height,a[d],a[d+1],Et,Kt,p,_,Ze,je,Vt,He,o,qt,!!Dt||!!Ot,b),at=[t,e,R,N,Ne,Dt,Ot];if(l){let Z,K,j;if(xt){const B=g-d;if(!xt[B]){xt[B]={args:at,declutterMode:x};continue}const X=xt[B];Z=X.args,K=X.declutterMode,delete xt[B],j=Ee(Z)}let q,z;if(Z&&(K!=="declutter"||!l.collides(j))&&(q=!0),(x!=="declutter"||!l.collides(N.declutterBox))&&(z=!0),K==="declutter"&&x==="declutter"){const B=q&&z;q=B,z=B}q&&(K!=="none"&&l.insert(j),this.replayImageOrLabel_.apply(this,Z)),z&&(x!=="none"&&l.insert(N.declutterBox),this.replayImageOrLabel_.apply(this,at))}else this.replayImageOrLabel_.apply(this,at)}++c;break;case T.DRAW_CHARS:const fe=y[1],ue=y[2],zt=y[3],Ke=y[4];A=y[5];const Ve=y[6],ge=y[7],_e=y[8];L=y[9];const Qt=y[10];w=y[11],Array.isArray(w)&&(w=w.reduce(bi,"")),E=y[12];const xe=[y[13],y[13]];x=y[14]||"declutter";const Ue=y[15],$t=this.textStates[E],pt=$t.font,St=[$t.scale[0]*ge,$t.scale[1]*ge];let mt;pt in this.widths_?mt=this.widths_[pt]:(mt={},this.widths_[pt]=mt);const pe=Di(a,fe,ue,2),Se=Math.abs(St[0])*Te(pt,w,mt);if(Ke||Se<=pe){const N=this.textStates[E].textAlign,at=(pe-Se)*te(w,N),Z=Oi(a,fe,ue,2,w,at,Ve,Math.abs(St[0]),Te,pt,mt,O?0:this.viewRotation_,Ue);t:if(Z){const K=[];let j,q,z,B,X;if(L)for(j=0,q=Z.length;j<q;++j){X=Z[j],z=X[4],B=this.createLabel(z,E,"",L),p=X[2]+(St[0]<0?-Qt:Qt),_=zt*B.height+(.5-zt)*2*Qt*St[1]/St[0]-_e;const Q=this.calculateImageOrLabelDimensions_(B.width,B.height,X[0],X[1],B.width,B.height,p,_,0,0,X[3],xe,!1,ht,!1,b);if(l&&x==="declutter"&&l.collides(Q.declutterBox))break t;K.push([t,e,B,Q,1,null,null])}if(A)for(j=0,q=Z.length;j<q;++j){X=Z[j],z=X[4],B=this.createLabel(z,E,A,""),p=X[2],_=zt*B.height-_e;const Q=this.calculateImageOrLabelDimensions_(B.width,B.height,X[0],X[1],B.width,B.height,p,_,0,0,X[3],xe,!1,ht,!1,b);if(l&&x==="declutter"&&l.collides(Q.declutterBox))break t;K.push([t,e,B,Q,1,null,null])}l&&x!=="none"&&l.load(K.map(Ee));for(let Q=0,qe=K.length;Q<qe;++Q)this.replayImageOrLabel_.apply(this,K[Q])}}++c;break;case T.END_GEOMETRY:if(s!==void 0){b=y[1];const N=s(b,Y,x);if(N)return N}++c;break;case T.FILL:k?W++:this.fill_(t),++c;break;case T.MOVE_TO_LINE_TO:for(d=y[1],g=y[2],G=a[d],v=a[d+1],t.moveTo(G,v),S=G+.5|0,C=v+.5|0,d+=2;d<g;d+=2)G=a[d],v=a[d+1],m=G+.5|0,I=v+.5|0,(d==g-2||m!==S||I!==C)&&(t.lineTo(G,v),S=m,C=I);++c;break;case T.SET_FILL_STYLE:this.alignAndScaleFill_=y[2],W&&(this.fill_(t),W=0,D&&(t.stroke(),D=0)),t.fillStyle=y[1],++c;break;case T.SET_STROKE_STYLE:D&&(t.stroke(),D=0),this.setStrokeStyle_(t,y),++c;break;case T.STROKE:k?D++:t.stroke(),++c;break;default:++c;break}}W&&this.fill_(t),D&&t.stroke()}execute(t,e,i,n,o,s){this.viewRotation_=n,this.execute_(t,e,i,this.instructions,o,void 0,void 0,s)}executeHitDetection(t,e,i,n,o){return this.viewRotation_=i,this.execute_(t,[t.canvas.width,t.canvas.height],e,this.hitDetectionInstructions,!0,n,o)}}const ft=["Polygon","Circle","LineString","Image","Text","Default"],Ae=["Image","Text"],Wi=ft.filter(u=>!Ae.includes(u));class Ai{constructor(t,e,i,n,o,s,r){this.maxExtent_=t,this.overlaps_=n,this.pixelRatio_=i,this.resolution_=e,this.renderBuffer_=s,this.executorsByZIndex_={},this.hitDetectionContext_=null,this.hitDetectionTransform_=jt(),this.renderedContext_=null,this.deferredZIndexContexts_={},this.createExecutors_(o,r)}clip(t,e){const i=this.getClipCoords(e);t.beginPath(),t.moveTo(i[0],i[1]),t.lineTo(i[2],i[3]),t.lineTo(i[4],i[5]),t.lineTo(i[6],i[7]),t.clip()}createExecutors_(t,e){for(const i in t){let n=this.executorsByZIndex_[i];n===void 0&&(n={},this.executorsByZIndex_[i]=n);const o=t[i];for(const s in o){const r=o[s];n[s]=new Mi(this.resolution_,this.pixelRatio_,this.overlaps_,r,e)}}}hasExecutors(t){for(const e in this.executorsByZIndex_){const i=this.executorsByZIndex_[e];for(let n=0,o=t.length;n<o;++n)if(t[n]in i)return!0}return!1}forEachFeatureAtCoordinate(t,e,i,n,o,s){n=Math.round(n);const r=n*2+1,l=re(this.hitDetectionTransform_,n+.5,n+.5,1/e,-1/e,-i,-t[0],-t[1]),h=!this.hitDetectionContext_;h&&(this.hitDetectionContext_=vt(r,r));const a=this.hitDetectionContext_;a.canvas.width!==r||a.canvas.height!==r?(a.canvas.width=r,a.canvas.height=r):h||a.clearRect(0,0,r,r);let c;this.renderBuffer_!==void 0&&(c=Pt(),ni(c,t),oe(c,e*(this.renderBuffer_+n),c));const f=Pi(n);let d;function g(I,R,w){const E=a.getImageData(0,0,r,r).data;for(let L=0,A=f.length;L<A;L++)if(E[f[L]]>0){if(!s||w==="none"||d!=="Image"&&d!=="Text"||s.includes(I)){const W=(f[L]-3)/4,D=n-W%r,M=n-(W/r|0),P=o(I,R,D*D+M*M);if(P)return P}a.clearRect(0,0,r,r);break}}const p=Object.keys(this.executorsByZIndex_).map(Number);p.sort(At);let _,x,S,C,m;for(_=p.length-1;_>=0;--_){const I=p[_].toString();for(S=this.executorsByZIndex_[I],x=ft.length-1;x>=0;--x)if(d=ft[x],C=S[d],C!==void 0&&(m=C.executeHitDetection(a,l,i,g,c),m))return m}}getClipCoords(t){const e=this.maxExtent_;if(!e)return null;const i=e[0],n=e[1],o=e[2],s=e[3],r=[i,n,i,s,o,s,o,n];return It(r,0,8,2,t,r),r}isEmpty(){return Qe(this.executorsByZIndex_)}execute(t,e,i,n,o,s,r){const l=Object.keys(this.executorsByZIndex_).map(Number);l.sort(r?$e:At),s=s||ft;const h=ft.length;for(let a=0,c=l.length;a<c;++a){const f=l[a].toString(),d=this.executorsByZIndex_[f];for(let g=0,p=s.length;g<p;++g){const _=s[g],x=d[_];if(x!==void 0){const S=r===null?void 0:x.getZIndexContext(),C=S?S.getContext():t,m=this.maxExtent_&&_!=="Image"&&_!=="Text";if(m&&(C.save(),this.clip(C,i)),!S||_==="Text"||_==="Image"?x.execute(C,e,i,n,o,r):S.pushFunction(I=>x.execute(I,e,i,n,o,r)),m&&C.restore(),S){S.offset();const I=l[a]*h+g;this.deferredZIndexContexts_[I]||(this.deferredZIndexContexts_[I]=[]),this.deferredZIndexContexts_[I].push(S)}}}}this.renderedContext_=t}getDeferredZIndexContexts(){return this.deferredZIndexContexts_}getRenderedContext(){return this.renderedContext_}renderDeferred(){const t=this.deferredZIndexContexts_,e=Object.keys(t).map(Number).sort(At);for(let i=0,n=e.length;i<n;++i)t[e[i]].forEach(o=>{o.draw(this.renderedContext_),o.clear()}),t[e[i]].length=0}}const ee={};function Pi(u){if(ee[u]!==void 0)return ee[u];const t=u*2+1,e=u*u,i=new Array(e+1);for(let o=0;o<=u;++o)for(let s=0;s<=u;++s){const r=o*o+s*s;if(r>e)break;let l=i[r];l||(l=[],i[r]=l),l.push(((u+o)*t+(u+s))*4+3),o>0&&l.push(((u-o)*t+(u+s))*4+3),s>0&&(l.push(((u+o)*t+(u-s))*4+3),o>0&&l.push(((u-o)*t+(u-s))*4+3))}const n=[];for(let o=0,s=i.length;o<s;++o)i[o]&&n.push(...i[o]);return ee[u]=n,n}class vi extends We{constructor(t,e,i,n,o,s,r){super(),this.context_=t,this.pixelRatio_=e,this.extent_=i,this.transform_=n,this.transformRotation_=n?gi(Math.atan2(n[1],n[0]),10):0,this.viewRotation_=o,this.squaredTolerance_=s,this.userTransform_=r,this.contextFillState_=null,this.contextStrokeState_=null,this.contextTextState_=null,this.fillState_=null,this.strokeState_=null,this.image_=null,this.imageAnchorX_=0,this.imageAnchorY_=0,this.imageHeight_=0,this.imageOpacity_=0,this.imageOriginX_=0,this.imageOriginY_=0,this.imageRotateWithView_=!1,this.imageRotation_=0,this.imageScale_=[0,0],this.imageWidth_=0,this.text_="",this.textOffsetX_=0,this.textOffsetY_=0,this.textRotateWithView_=!1,this.textRotation_=0,this.textScale_=[0,0],this.textFillState_=null,this.textStrokeState_=null,this.textState_=null,this.pixelCoordinates_=[],this.tmpLocalTransform_=jt()}drawImages_(t,e,i,n){if(!this.image_)return;const o=It(t,e,i,n,this.transform_,this.pixelCoordinates_),s=this.context_,r=this.tmpLocalTransform_,l=s.globalAlpha;this.imageOpacity_!=1&&(s.globalAlpha=l*this.imageOpacity_);let h=this.imageRotation_;this.transformRotation_===0&&(h-=this.viewRotation_),this.imageRotateWithView_&&(h+=this.viewRotation_);for(let a=0,c=o.length;a<c;a+=2){const f=o[a]-this.imageAnchorX_,d=o[a+1]-this.imageAnchorY_;if(h!==0||this.imageScale_[0]!=1||this.imageScale_[1]!=1){const g=f+this.imageAnchorX_,p=d+this.imageAnchorY_;re(r,g,p,1,1,h,-g,-p),s.save(),s.transform.apply(s,r),s.translate(g,p),s.scale(this.imageScale_[0],this.imageScale_[1]),s.drawImage(this.image_,this.imageOriginX_,this.imageOriginY_,this.imageWidth_,this.imageHeight_,-this.imageAnchorX_,-this.imageAnchorY_,this.imageWidth_,this.imageHeight_),s.restore()}else s.drawImage(this.image_,this.imageOriginX_,this.imageOriginY_,this.imageWidth_,this.imageHeight_,f,d,this.imageWidth_,this.imageHeight_)}this.imageOpacity_!=1&&(s.globalAlpha=l)}drawText_(t,e,i,n){if(!this.textState_||this.text_==="")return;this.textFillState_&&this.setContextFillState_(this.textFillState_),this.textStrokeState_&&this.setContextStrokeState_(this.textStrokeState_),this.setContextTextState_(this.textState_);const o=It(t,e,i,n,this.transform_,this.pixelCoordinates_),s=this.context_;let r=this.textRotation_;for(this.transformRotation_===0&&(r-=this.viewRotation_),this.textRotateWithView_&&(r+=this.viewRotation_);e<i;e+=n){const l=o[e]+this.textOffsetX_,h=o[e+1]+this.textOffsetY_;r!==0||this.textScale_[0]!=1||this.textScale_[1]!=1?(s.save(),s.translate(l-this.textOffsetX_,h-this.textOffsetY_),s.rotate(r),s.translate(this.textOffsetX_,this.textOffsetY_),s.scale(this.textScale_[0],this.textScale_[1]),this.textStrokeState_&&s.strokeText(this.text_,0,0),this.textFillState_&&s.fillText(this.text_,0,0),s.restore()):(this.textStrokeState_&&s.strokeText(this.text_,l,h),this.textFillState_&&s.fillText(this.text_,l,h))}}moveToLineTo_(t,e,i,n,o){const s=this.context_,r=It(t,e,i,n,this.transform_,this.pixelCoordinates_);s.moveTo(r[0],r[1]);let l=r.length;o&&(l-=2);for(let h=2;h<l;h+=2)s.lineTo(r[h],r[h+1]);return o&&s.closePath(),i}drawRings_(t,e,i,n){for(let o=0,s=i.length;o<s;++o)e=this.moveToLineTo_(t,e,i[o],n,!0);return e}drawCircle(t){if(this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_)),!!et(this.extent_,t.getExtent())){if(this.fillState_||this.strokeState_){this.fillState_&&this.setContextFillState_(this.fillState_),this.strokeState_&&this.setContextStrokeState_(this.strokeState_);const e=mi(t,this.transform_,this.pixelCoordinates_),i=e[2]-e[0],n=e[3]-e[1],o=Math.sqrt(i*i+n*n),s=this.context_;s.beginPath(),s.arc(e[0],e[1],o,0,2*Math.PI),this.fillState_&&s.fill(),this.strokeState_&&s.stroke()}this.text_!==""&&this.drawText_(t.getCenter(),0,2,2)}}setStyle(t){this.setFillStrokeStyle(t.getFill(),t.getStroke()),this.setImageStyle(t.getImage()),this.setTextStyle(t.getText())}setTransform(t){this.transform_=t}drawGeometry(t){switch(t.getType()){case"Point":this.drawPoint(t);break;case"LineString":this.drawLineString(t);break;case"Polygon":this.drawPolygon(t);break;case"MultiPoint":this.drawMultiPoint(t);break;case"MultiLineString":this.drawMultiLineString(t);break;case"MultiPolygon":this.drawMultiPolygon(t);break;case"GeometryCollection":this.drawGeometryCollection(t);break;case"Circle":this.drawCircle(t);break}}drawFeature(t,e){const i=e.getGeometryFunction()(t);i&&(this.setStyle(e),this.drawGeometry(i))}drawGeometryCollection(t){const e=t.getGeometriesArray();for(let i=0,n=e.length;i<n;++i)this.drawGeometry(e[i])}drawPoint(t){this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_));const e=t.getFlatCoordinates(),i=t.getStride();this.image_&&this.drawImages_(e,0,e.length,i),this.text_!==""&&this.drawText_(e,0,e.length,i)}drawMultiPoint(t){this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_));const e=t.getFlatCoordinates(),i=t.getStride();this.image_&&this.drawImages_(e,0,e.length,i),this.text_!==""&&this.drawText_(e,0,e.length,i)}drawLineString(t){if(this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_)),!!et(this.extent_,t.getExtent())){if(this.strokeState_){this.setContextStrokeState_(this.strokeState_);const e=this.context_,i=t.getFlatCoordinates();e.beginPath(),this.moveToLineTo_(i,0,i.length,t.getStride(),!1),e.stroke()}if(this.text_!==""){const e=t.getFlatMidpoint();this.drawText_(e,0,2,2)}}}drawMultiLineString(t){this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_));const e=t.getExtent();if(et(this.extent_,e)){if(this.strokeState_){this.setContextStrokeState_(this.strokeState_);const i=this.context_,n=t.getFlatCoordinates();let o=0;const s=t.getEnds(),r=t.getStride();i.beginPath();for(let l=0,h=s.length;l<h;++l)o=this.moveToLineTo_(n,o,s[l],r,!1);i.stroke()}if(this.text_!==""){const i=t.getFlatMidpoints();this.drawText_(i,0,i.length,2)}}}drawPolygon(t){if(this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_)),!!et(this.extent_,t.getExtent())){if(this.strokeState_||this.fillState_){this.fillState_&&this.setContextFillState_(this.fillState_),this.strokeState_&&this.setContextStrokeState_(this.strokeState_);const e=this.context_;e.beginPath(),this.drawRings_(t.getOrientedFlatCoordinates(),0,t.getEnds(),t.getStride()),this.fillState_&&e.fill(),this.strokeState_&&e.stroke()}if(this.text_!==""){const e=t.getFlatInteriorPoint();this.drawText_(e,0,2,2)}}}drawMultiPolygon(t){if(this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_)),!!et(this.extent_,t.getExtent())){if(this.strokeState_||this.fillState_){this.fillState_&&this.setContextFillState_(this.fillState_),this.strokeState_&&this.setContextStrokeState_(this.strokeState_);const e=this.context_,i=t.getOrientedFlatCoordinates();let n=0;const o=t.getEndss(),s=t.getStride();e.beginPath();for(let r=0,l=o.length;r<l;++r){const h=o[r];n=this.drawRings_(i,n,h,s)}this.fillState_&&e.fill(),this.strokeState_&&e.stroke()}if(this.text_!==""){const e=t.getFlatInteriorPoints();this.drawText_(e,0,e.length,2)}}}setContextFillState_(t){const e=this.context_,i=this.contextFillState_;i?i.fillStyle!=t.fillStyle&&(i.fillStyle=t.fillStyle,e.fillStyle=t.fillStyle):(e.fillStyle=t.fillStyle,this.contextFillState_={fillStyle:t.fillStyle})}setContextStrokeState_(t){const e=this.context_,i=this.contextStrokeState_;i?(i.lineCap!=t.lineCap&&(i.lineCap=t.lineCap,e.lineCap=t.lineCap),Jt(i.lineDash,t.lineDash)||e.setLineDash(i.lineDash=t.lineDash),i.lineDashOffset!=t.lineDashOffset&&(i.lineDashOffset=t.lineDashOffset,e.lineDashOffset=t.lineDashOffset),i.lineJoin!=t.lineJoin&&(i.lineJoin=t.lineJoin,e.lineJoin=t.lineJoin),i.lineWidth!=t.lineWidth&&(i.lineWidth=t.lineWidth,e.lineWidth=t.lineWidth),i.miterLimit!=t.miterLimit&&(i.miterLimit=t.miterLimit,e.miterLimit=t.miterLimit),i.strokeStyle!=t.strokeStyle&&(i.strokeStyle=t.strokeStyle,e.strokeStyle=t.strokeStyle)):(e.lineCap=t.lineCap,e.setLineDash(t.lineDash),e.lineDashOffset=t.lineDashOffset,e.lineJoin=t.lineJoin,e.lineWidth=t.lineWidth,e.miterLimit=t.miterLimit,e.strokeStyle=t.strokeStyle,this.contextStrokeState_={lineCap:t.lineCap,lineDash:t.lineDash,lineDashOffset:t.lineDashOffset,lineJoin:t.lineJoin,lineWidth:t.lineWidth,miterLimit:t.miterLimit,strokeStyle:t.strokeStyle})}setContextTextState_(t){const e=this.context_,i=this.contextTextState_,n=t.textAlign?t.textAlign:kt;i?(i.font!=t.font&&(i.font=t.font,e.font=t.font),i.textAlign!=n&&(i.textAlign=n,e.textAlign=n),i.textBaseline!=t.textBaseline&&(i.textBaseline=t.textBaseline,e.textBaseline=t.textBaseline)):(e.font=t.font,e.textAlign=n,e.textBaseline=t.textBaseline,this.contextTextState_={font:t.font,textAlign:n,textBaseline:t.textBaseline})}setFillStrokeStyle(t,e){if(!t)this.fillState_=null;else{const i=t.getColor();this.fillState_={fillStyle:rt(i||H)}}if(!e)this.strokeState_=null;else{const i=e.getColor(),n=e.getLineCap(),o=e.getLineDash(),s=e.getLineDashOffset(),r=e.getLineJoin(),l=e.getWidth(),h=e.getMiterLimit(),a=o||it;this.strokeState_={lineCap:n!==void 0?n:Bt,lineDash:this.pixelRatio_===1?a:a.map(c=>c*this.pixelRatio_),lineDashOffset:(s||nt)*this.pixelRatio_,lineJoin:r!==void 0?r:Gt,lineWidth:(l!==void 0?l:Yt)*this.pixelRatio_,miterLimit:h!==void 0?h:Xt,strokeStyle:rt(i||Nt)}}}setImageStyle(t){let e;if(!t||!(e=t.getSize())){this.image_=null;return}const i=t.getPixelRatio(this.pixelRatio_),n=t.getAnchor(),o=t.getOrigin();this.image_=t.getImage(this.pixelRatio_),this.imageAnchorX_=n[0]*i,this.imageAnchorY_=n[1]*i,this.imageHeight_=e[1]*i,this.imageOpacity_=t.getOpacity(),this.imageOriginX_=o[0],this.imageOriginY_=o[1],this.imageRotateWithView_=t.getRotateWithView(),this.imageRotation_=t.getRotation();const s=t.getScaleArray();this.imageScale_=[s[0]*this.pixelRatio_/i,s[1]*this.pixelRatio_/i],this.imageWidth_=e[0]*i}setTextStyle(t){if(!t)this.text_="";else{const e=t.getFill();if(!e)this.textFillState_=null;else{const d=e.getColor();this.textFillState_={fillStyle:rt(d||H)}}const i=t.getStroke();if(!i)this.textStrokeState_=null;else{const d=i.getColor(),g=i.getLineCap(),p=i.getLineDash(),_=i.getLineDashOffset(),x=i.getLineJoin(),S=i.getWidth(),C=i.getMiterLimit();this.textStrokeState_={lineCap:g!==void 0?g:Bt,lineDash:p||it,lineDashOffset:_||nt,lineJoin:x!==void 0?x:Gt,lineWidth:S!==void 0?S:Yt,miterLimit:C!==void 0?C:Xt,strokeStyle:rt(d||Nt)}}const n=t.getFont(),o=t.getOffsetX(),s=t.getOffsetY(),r=t.getRotateWithView(),l=t.getRotation(),h=t.getScaleArray(),a=t.getText(),c=t.getTextAlign(),f=t.getTextBaseline();this.textState_={font:n!==void 0?n:Me,textAlign:c!==void 0?c:kt,textBaseline:f!==void 0?f:Zt},this.text_=a!==void 0?Array.isArray(a)?a.reduce((d,g,p)=>d+=p%2?" ":g,""):a:"",this.textOffsetX_=o!==void 0?this.pixelRatio_*o:0,this.textOffsetY_=s!==void 0?this.pixelRatio_*s:0,this.textRotateWithView_=r!==void 0?r:!1,this.textRotation_=l!==void 0?l:0,this.textScale_=[this.pixelRatio_*h[0],this.pixelRatio_*h[1]]}}}const U=.5;function Bi(u,t,e,i,n,o,s,r,l){const h=l?ne(n,l):n,a=u[0]*U,c=u[1]*U,f=vt(a,c);f.imageSmoothingEnabled=!1;const d=f.canvas,g=new vi(f,U,n,null,s,r,l?be(se(),l):null),p=e.length,_=Math.floor((256*256*256-1)/p),x={};for(let C=1;C<=p;++C){const m=e[C-1],I=m.getStyleFunction()||i;if(!I)continue;let R=I(m,o);if(!R)continue;Array.isArray(R)||(R=[R]);const E=(C*_).toString(16).padStart(7,"#00000");for(let L=0,A=R.length;L<A;++L){const W=R[L],D=W.getGeometryFunction()(m);if(!D||!et(h,D.getExtent()))continue;const M=W.clone(),P=M.getFill();P&&P.setColor(E);const O=M.getStroke();O&&(O.setColor(E),O.setLineDash(null)),M.setText(void 0);const F=W.getImage();if(F){const v=F.getImageSize();if(!v)continue;const Y=vt(v[0],v[1],void 0,{alpha:!1}),y=Y.canvas;Y.fillStyle=E,Y.fillRect(0,0,y.width,y.height),M.setImage(new yi({img:y,anchor:F.getAnchor(),anchorXUnits:"pixels",anchorYUnits:"pixels",offset:F.getOrigin(),opacity:1,size:F.getSize(),scale:F.getScale(),rotation:F.getRotation(),rotateWithView:F.getRotateWithView()}))}const k=M.getZIndex()||0;let b=x[k];b||(b={},x[k]=b,b.Polygon=[],b.Circle=[],b.LineString=[],b.Point=[]);const G=D.getType();if(G==="GeometryCollection"){const v=D.getGeometriesArrayRecursive();for(let Y=0,y=v.length;Y<y;++Y){const ut=v[Y];b[ut.getType().replace("Multi","")].push(ut,M)}}else b[G.replace("Multi","")].push(D,M)}}const S=Object.keys(x).map(Number).sort(At);for(let C=0,m=S.length;C<m;++C){const I=x[S[C]];for(const R in I){const w=I[R];for(let E=0,L=w.length;E<L;E+=2){g.setStyle(w[E+1]);for(let A=0,W=t.length;A<W;++A)g.setTransform(t[A]),g.drawGeometry(w[E])}}}return f.getImageData(0,0,d.width,d.height)}function Gi(u,t,e){const i=[];if(e){const n=Math.floor(Math.round(u[0])*U),o=Math.floor(Math.round(u[1])*U),s=(Re(n,0,e.width-1)+Re(o,0,e.height-1)*e.width)*4,r=e.data[s],l=e.data[s+1],a=e.data[s+2]+256*(l+256*r),c=Math.floor((256*256*256-1)/t.length);a&&a%c===0&&i.push(t[a/c-1])}return i}const Yi=.5,Pe={Point:Vi,LineString:Hi,Polygon:qi,MultiPoint:Ui,MultiLineString:Ji,MultiPolygon:Ki,GeometryCollection:ji,Circle:Ni};function Xi(u,t){return parseInt(Rt(u),10)-parseInt(Rt(t),10)}function Oe(u,t){const e=ve(u,t);return e*e}function ve(u,t){return Yi*u/t}function Ni(u,t,e,i,n){const o=e.getFill(),s=e.getStroke();if(o||s){const l=u.getBuilder(e.getZIndex(),"Circle");l.setFillStrokeStyle(o,s),l.drawCircle(t,i,n)}const r=e.getText();if(r&&r.getText()){const l=u.getBuilder(e.getZIndex(),"Text");l.setTextStyle(r),l.drawText(t,i)}}function Fe(u,t,e,i,n,o,s,r){const l=[],h=e.getImage();if(h){let f=!0;const d=h.getImageState();d==Tt.LOADED||d==Tt.ERROR?f=!1:d==Tt.IDLE&&h.load(),f&&l.push(h.ready())}const a=e.getFill();a&&a.loading()&&l.push(a.ready());const c=l.length>0;return c&&Promise.all(l).then(()=>n(null)),Zi(u,t,e,i,o,s,r),c}function Zi(u,t,e,i,n,o,s){const r=e.getGeometryFunction()(t);if(!r)return;const l=r.simplifyTransformed(i,n);if(e.getRenderer())Be(u,l,e,t,s);else{const a=Pe[l.getType()];a(u,l,e,t,s,o)}}function Be(u,t,e,i,n){if(t.getType()=="GeometryCollection"){const s=t.getGeometries();for(let r=0,l=s.length;r<l;++r)Be(u,s[r],e,i,n);return}u.getBuilder(e.getZIndex(),"Default").drawCustom(t,i,e.getRenderer(),e.getHitDetectionRenderer(),n)}function ji(u,t,e,i,n,o){const s=t.getGeometriesArray();let r,l;for(r=0,l=s.length;r<l;++r){const h=Pe[s[r].getType()];h(u,s[r],e,i,n,o)}}function Hi(u,t,e,i,n){const o=e.getStroke();if(o){const r=u.getBuilder(e.getZIndex(),"LineString");r.setFillStrokeStyle(null,o),r.drawLineString(t,i,n)}const s=e.getText();if(s&&s.getText()){const r=u.getBuilder(e.getZIndex(),"Text");r.setTextStyle(s),r.drawText(t,i,n)}}function Ji(u,t,e,i,n){const o=e.getStroke();if(o){const r=u.getBuilder(e.getZIndex(),"LineString");r.setFillStrokeStyle(null,o),r.drawMultiLineString(t,i,n)}const s=e.getText();if(s&&s.getText()){const r=u.getBuilder(e.getZIndex(),"Text");r.setTextStyle(s),r.drawText(t,i,n)}}function Ki(u,t,e,i,n){const o=e.getFill(),s=e.getStroke();if(s||o){const l=u.getBuilder(e.getZIndex(),"Polygon");l.setFillStrokeStyle(o,s),l.drawMultiPolygon(t,i,n)}const r=e.getText();if(r&&r.getText()){const l=u.getBuilder(e.getZIndex(),"Text");l.setTextStyle(r),l.drawText(t,i,n)}}function Vi(u,t,e,i,n,o){const s=e.getImage(),r=e.getText(),l=r&&r.getText(),h=o&&s&&l?{}:void 0;if(s){if(s.getImageState()!=Tt.LOADED)return;const a=u.getBuilder(e.getZIndex(),"Image");a.setImageStyle(s,h),a.drawPoint(t,i,n)}if(l){const a=u.getBuilder(e.getZIndex(),"Text");a.setTextStyle(r,h),a.drawText(t,i,n)}}function Ui(u,t,e,i,n,o){const s=e.getImage(),r=s&&s.getOpacity()!==0,l=e.getText(),h=l&&l.getText(),a=o&&r&&h?{}:void 0;if(r){if(s.getImageState()!=Tt.LOADED)return;const c=u.getBuilder(e.getZIndex(),"Image");c.setImageStyle(s,a),c.drawMultiPoint(t,i,n)}if(h){const c=u.getBuilder(e.getZIndex(),"Text");c.setTextStyle(l,a),c.drawText(t,i,n)}}function qi(u,t,e,i,n){const o=e.getFill(),s=e.getStroke();if(o||s){const l=u.getBuilder(e.getZIndex(),"Polygon");l.setFillStrokeStyle(o,s),l.drawPolygon(t,i,n)}const r=e.getText();if(r&&r.getText()){const l=u.getBuilder(e.getZIndex(),"Text");l.setTextStyle(r),l.drawText(t,i,n)}}class zi extends Si{constructor(t){super(t),this.boundHandleStyleImageChange_=this.handleStyleImageChange_.bind(this),this.animatingOrInteracting_,this.hitDetectionImageData_=null,this.clipped_=!1,this.renderedFeatures_=null,this.renderedRevision_=-1,this.renderedResolution_=NaN,this.renderedExtent_=Pt(),this.wrappedRenderedExtent_=Pt(),this.renderedRotation_,this.renderedCenter_=null,this.renderedProjection_=null,this.renderedPixelRatio_=1,this.renderedRenderOrder_=null,this.renderedFrameDeclutter_,this.replayGroup_=null,this.replayGroupChanged=!0,this.clipping=!0,this.targetContext_=null,this.opacity_=1}renderWorlds(t,e,i){const n=e.extent,o=e.viewState,s=o.center,r=o.resolution,l=o.projection,h=o.rotation,a=l.getExtent(),c=this.getLayer().getSource(),f=this.getLayer().getDeclutter(),d=e.pixelRatio,g=e.viewHints,p=!(g[bt.ANIMATING]||g[bt.INTERACTING]),_=this.context,x=Math.round(yt(n)/r*d),S=Math.round(si(n)/r*d),C=c.getWrapX()&&l.canWrapX(),m=C?yt(a):null,I=C?Math.ceil((n[2]-a[2])/m)+1:1;let R=C?Math.floor((n[0]-a[0])/m):0;do{let w=this.getRenderTransform(s,r,0,d,x,S,R*m);e.declutter&&(w=w.slice(0)),t.execute(_,[_.canvas.width,_.canvas.height],w,h,p,i===void 0?ft:i?Ae:Wi,i?f&&e.declutter[f]:void 0)}while(++R<I)}setDrawContext_(){this.opacity_!==1&&(this.targetContext_=this.context,this.context=vt(this.context.canvas.width,this.context.canvas.height,ke))}resetDrawContext_(){if(this.opacity_!==1){const t=this.targetContext_.globalAlpha;this.targetContext_.globalAlpha=this.opacity_,this.targetContext_.drawImage(this.context.canvas,0,0),this.targetContext_.globalAlpha=t,hi(this.context),ke.push(this.context.canvas),this.context=this.targetContext_,this.targetContext_=null}}renderDeclutter(t){!this.replayGroup_||!this.getLayer().getDeclutter()||this.renderWorlds(this.replayGroup_,t,!0)}renderDeferredInternal(t){this.replayGroup_&&(this.replayGroup_.renderDeferred(),this.clipped_&&this.context.restore(),this.resetDrawContext_())}renderFrame(t,e){const i=t.layerStatesArray[t.layerIndex];this.opacity_=i.opacity;const n=t.viewState;this.prepareContainer(t,e);const o=this.context,s=this.replayGroup_;let r=s&&!s.isEmpty();if(!r&&!(this.getLayer().hasListener(Ie.PRERENDER)||this.getLayer().hasListener(Ie.POSTRENDER)))return this.container;this.setDrawContext_(),this.preRender(o,t);const l=n.projection;if(this.clipped_=!1,r&&i.extent&&this.clipping){const h=oi(i.extent,l);r=et(h,t.extent),this.clipped_=r&&!Mt(h,t.extent),this.clipped_&&this.clipUnrotated(o,t,h)}return r&&this.renderWorlds(s,t,this.getLayer().getDeclutter()?!1:void 0),!t.declutter&&this.clipped_&&o.restore(),this.postRender(o,t),this.renderedRotation_!==n.rotation&&(this.renderedRotation_=n.rotation,this.hitDetectionImageData_=null),t.declutter||this.resetDrawContext_(),this.container}getFeatures(t){return new Promise(e=>{if(this.frameState&&!this.hitDetectionImageData_&&!this.animatingOrInteracting_){const i=this.frameState.size.slice(),n=this.renderedCenter_,o=this.renderedResolution_,s=this.renderedRotation_,r=this.renderedProjection_,l=this.wrappedRenderedExtent_,h=this.getLayer(),a=[],c=i[0]*U,f=i[1]*U;a.push(this.getRenderTransform(n,o,s,U,c,f,0).slice());const d=h.getSource(),g=r.getExtent();if(d.getWrapX()&&r.canWrapX()&&!Mt(g,l)){let _=l[0];const x=yt(g);let S=0,C;for(;_<g[0];)--S,C=x*S,a.push(this.getRenderTransform(n,o,s,U,c,f,C).slice()),_+=x;for(S=0,_=l[2];_>g[2];)++S,C=x*S,a.push(this.getRenderTransform(n,o,s,U,c,f,C).slice()),_-=x}const p=se();this.hitDetectionImageData_=Bi(i,a,this.renderedFeatures_,h.getStyleFunction(),l,o,s,Oe(o,this.renderedPixelRatio_),p?r:null)}e(Gi(t,this.renderedFeatures_,this.hitDetectionImageData_))})}forEachFeatureAtCoordinate(t,e,i,n,o){var f,d;if(!this.replayGroup_)return;const s=e.viewState.resolution,r=e.viewState.rotation,l=this.getLayer(),h={},a=function(g,p,_){const x=Rt(g),S=h[x];if(S){if(S!==!0&&_<S.distanceSq){if(_===0)return h[x]=!0,o.splice(o.lastIndexOf(S),1),n(g,l,p);S.geometry=p,S.distanceSq=_}}else{if(_===0)return h[x]=!0,n(g,l,p);o.push(h[x]={feature:g,layer:l,geometry:p,distanceSq:_,callback:n})}},c=this.getLayer().getDeclutter();return this.replayGroup_.forEachFeatureAtCoordinate(t,s,r,i,a,c?(d=(f=e.declutter)==null?void 0:f[c])==null?void 0:d.all().map(g=>g.value):null)}handleFontsChanged(){const t=this.getLayer();t.getVisible()&&this.replayGroup_&&t.changed()}handleStyleImageChange_(t){this.renderIfReadyAndVisible()}prepareFrame(t){const e=this.getLayer(),i=e.getSource();if(!i)return!1;const n=t.viewHints[bt.ANIMATING],o=t.viewHints[bt.INTERACTING],s=e.getUpdateWhileAnimating(),r=e.getUpdateWhileInteracting();if(this.ready&&!s&&n||!r&&o)return this.animatingOrInteracting_=!0,!0;this.animatingOrInteracting_=!1;const l=t.extent,h=t.viewState,a=h.projection,c=h.resolution,f=t.pixelRatio,d=e.getRevision(),g=e.getRenderBuffer();let p=e.getRenderOrder();p===void 0&&(p=Xi);const _=h.center.slice(),x=oe(l,g*c),S=x.slice(),C=[x.slice()],m=a.getExtent();if(i.getWrapX()&&a.canWrapX()&&!Mt(m,t.extent)){const O=yt(m),F=Math.max(yt(x)/2,O);x[0]=m[0]-F,x[2]=m[2]+F,ri(_,a);const k=li(C[0],a);k[0]<m[0]&&k[2]<m[2]?C.push([k[0]+O,k[1],k[2]+O,k[3]]):k[0]>m[0]&&k[2]>m[2]&&C.push([k[0]-O,k[1],k[2]-O,k[3]])}if(this.ready&&this.renderedResolution_==c&&this.renderedRevision_==d&&this.renderedRenderOrder_==p&&this.renderedFrameDeclutter_===!!t.declutter&&Mt(this.wrappedRenderedExtent_,x))return Jt(this.renderedExtent_,S)||(this.hitDetectionImageData_=null,this.renderedExtent_=S),this.renderedCenter_=_,this.replayGroupChanged=!1,!0;this.replayGroup_=null;const I=new Ei(ve(c,f),x,c,f),R=se();let w;if(R){for(let O=0,F=C.length;O<F;++O){const k=C[O],b=ne(k,a);i.loadFeatures(b,ai(c,a),R)}w=be(R,a)}else for(let O=0,F=C.length;O<F;++O)i.loadFeatures(C[O],c,a);const E=Oe(c,f);let L=!0;const A=(O,F)=>{let k;const b=O.getStyleFunction()||e.getStyleFunction();if(b&&(k=b(O,c)),k){const G=this.renderFeature(O,E,k,I,w,this.getLayer().getDeclutter(),F);L=L&&!G}},W=ne(x,a),D=i.getFeaturesInExtent(W);p&&D.sort(p);for(let O=0,F=D.length;O<F;++O)A(D[O],O);this.renderedFeatures_=D,this.ready=L;const M=I.finish(),P=new Ai(x,c,f,i.getOverlaps(),M,e.getRenderBuffer(),!!t.declutter);return this.renderedResolution_=c,this.renderedRevision_=d,this.renderedRenderOrder_=p,this.renderedFrameDeclutter_=!!t.declutter,this.renderedExtent_=S,this.wrappedRenderedExtent_=x,this.renderedCenter_=_,this.renderedProjection_=a,this.renderedPixelRatio_=f,this.replayGroup_=P,this.hitDetectionImageData_=null,this.replayGroupChanged=!0,!0}renderFeature(t,e,i,n,o,s,r){if(!i)return!1;let l=!1;if(Array.isArray(i))for(let h=0,a=i.length;h<a;++h)l=Fe(n,t,i[h],e,this.boundHandleStyleImageChange_,o,s,r)||l;else l=Fe(n,t,i,e,this.boundHandleStyleImageChange_,o,s,r);return l}}class kn extends Ci{constructor(t){super(t)}createRenderer(){return new zi(this)}}export{kn as default};
