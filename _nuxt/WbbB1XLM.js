import{C as U,a as A}from"./D_H-TlYt.js";import{O as M}from"./sIom5plQ.js";import{o as X,m as L,n as N,g as _,j as C,V as Y,a as I,l as v,E as q,u as T,b as K,B as V}from"./DlQCJ7AR.js";import{a2 as D,j as B,a3 as k,z as H,q as W,u as G,e as P,p as j,L as z,T as J}from"./1jRA9jIJ.js";import{g as $,i as Q,a as Z,q as ee,b as te,d as se}from"./BzjKaiPX.js";import{l as ie}from"./Ba_gg6Bw.js";import{t as re}from"./CiY_2Xgg.js";import{c as ne,a as ae}from"./JfErLOBA.js";import{R as oe}from"./jYV8uuws.js";import{S as he}from"./DSyt37PD.js";import"./BNCPP-Lc.js";let le=!1;function ue(l,e,t,s,i,r,n){const a=new XMLHttpRequest;a.open("GET",typeof l=="function"?l(t,s,i):l,!0),e.getType()=="arraybuffer"&&(a.responseType="arraybuffer"),a.withCredentials=le,a.onload=function(o){if(!a.status||a.status>=200&&a.status<300){const u=e.getType();try{let h;u=="text"||u=="json"?h=a.responseText:u=="xml"?h=a.responseXML||a.responseText:u=="arraybuffer"&&(h=a.response),h?r(e.readFeatures(h,{extent:t,featureProjection:i}),e.readProjection(h)):n()}catch{n()}}else n()},a.onerror=n,a.send()}function O(l,e){return function(t,s,i,r,n){ue(l,e,t,s,i,(a,o)=>{this.addFeatures(a),r!==void 0&&r(a)},()=>{this.changed(),n!==void 0&&n()})}}function de(l,e){return[[-1/0,-1/0,1/0,1/0]]}function fe(l,e,t,s){const i=[];let r=B();for(let n=0,a=t.length;n<a;++n){const o=t[n];r=D(l,e,o[0],s),i.push((r[0]+r[2])/2,(r[1]+r[3])/2),e=o[o.length-1]}return i}function S(l,e,t,s,i,r,n){let a,o;const u=(t-e)/s;if(u===1)a=e;else if(u===2)a=e,o=i;else if(u!==0){let h=l[e],E=l[e+1],c=0;const y=[0];for(let p=e+s;p<t;p+=s){const x=l[p],F=l[p+1];c+=Math.sqrt((x-h)*(x-h)+(F-E)*(F-E)),y.push(c),h=x,E=F}const R=i*c,g=X(y,R);g<0?(o=(R-y[-g-2])/(y[-g-1]-y[-g-2]),a=e+(-g-2)*s):a=e+g*s}n=n>1?n:2,r=r||new Array(n);for(let h=0;h<n;++h)r[h]=a===void 0?NaN:o===void 0?l[a+h]:ie(l[a+h],l[a+s+h],o);return r}const b=ae();class f{constructor(e,t,s,i,r,n){this.styleFunction,this.extent_,this.id_=n,this.type_=e,this.flatCoordinates_=t,this.flatInteriorPoints_=null,this.flatMidpoints_=null,this.ends_=s||null,this.properties_=r,this.squaredTolerance_,this.stride_=i,this.simplifiedGeometry_}get(e){return this.properties_[e]}getExtent(){return this.extent_||(this.extent_=this.type_==="Point"?k(this.flatCoordinates_):D(this.flatCoordinates_,0,this.flatCoordinates_.length,2)),this.extent_}getFlatInteriorPoint(){if(!this.flatInteriorPoints_){const e=H(this.getExtent());this.flatInteriorPoints_=$(this.flatCoordinates_,0,this.ends_,2,e,0)}return this.flatInteriorPoints_}getFlatInteriorPoints(){if(!this.flatInteriorPoints_){const e=Q(this.flatCoordinates_,this.ends_),t=fe(this.flatCoordinates_,0,e,2);this.flatInteriorPoints_=Z(this.flatCoordinates_,0,e,2,t)}return this.flatInteriorPoints_}getFlatMidpoint(){return this.flatMidpoints_||(this.flatMidpoints_=S(this.flatCoordinates_,0,this.flatCoordinates_.length,2,.5)),this.flatMidpoints_}getFlatMidpoints(){if(!this.flatMidpoints_){this.flatMidpoints_=[];const e=this.flatCoordinates_;let t=0;const s=this.ends_;for(let i=0,r=s.length;i<r;++i){const n=s[i],a=S(e,t,n,2,.5);L(this.flatMidpoints_,a),t=n}}return this.flatMidpoints_}getId(){return this.id_}getOrientedFlatCoordinates(){return this.flatCoordinates_}getGeometry(){return this}getSimplifiedGeometry(e){return this}simplifyTransformed(e,t){return this}getProperties(){return this.properties_}getPropertiesInternal(){return this.properties_}getStride(){return this.stride_}getStyleFunction(){return this.styleFunction}getType(){return this.type_}transform(e){e=W(e);const t=e.getExtent(),s=e.getWorldExtent();if(t&&s){const i=G(s)/G(t);ne(b,s[0],s[3],i,-i,0,0,0),re(this.flatCoordinates_,0,this.flatCoordinates_.length,2,b,this.flatCoordinates_)}}applyTransform(e){e(this.flatCoordinates_,this.flatCoordinates_,this.stride_)}clone(){var e;return new f(this.type_,this.flatCoordinates_.slice(),(e=this.ends_)==null?void 0:e.slice(),this.stride_,Object.assign({},this.properties_),this.id_)}getEnds(){return this.ends_}enableSimplifyTransformed(){return this.simplifyTransformed=N((e,t)=>{if(e===this.squaredTolerance_)return this.simplifiedGeometry_;this.simplifiedGeometry_=this.clone(),t&&this.simplifiedGeometry_.applyTransform(t);const s=this.simplifiedGeometry_.getFlatCoordinates();let i;switch(this.type_){case"LineString":s.length=se(s,0,this.simplifiedGeometry_.flatCoordinates_.length,this.simplifiedGeometry_.stride_,e,s,0),i=[s.length];break;case"MultiLineString":i=[],s.length=te(s,0,this.simplifiedGeometry_.ends_,this.simplifiedGeometry_.stride_,e,s,0,i);break;case"Polygon":i=[],s.length=ee(s,0,this.simplifiedGeometry_.ends_,this.simplifiedGeometry_.stride_,Math.sqrt(e),s,0,i);break}return i&&(this.simplifiedGeometry_=new f(this.type_,s,i,2,this.properties_,this.id_)),this.squaredTolerance_=e,this.simplifiedGeometry_}),this}}f.prototype.getFlatCoordinates=f.prototype.getOrientedFlatCoordinates;class w{constructor(e){this.rbush_=new oe(e),this.items_={}}insert(e,t){const s={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3],value:t};this.rbush_.insert(s),this.items_[_(t)]=s}load(e,t){const s=new Array(t.length);for(let i=0,r=t.length;i<r;i++){const n=e[i],a=t[i],o={minX:n[0],minY:n[1],maxX:n[2],maxY:n[3],value:a};s[i]=o,this.items_[_(a)]=o}this.rbush_.load(s)}remove(e){const t=_(e),s=this.items_[t];return delete this.items_[t],this.rbush_.remove(s)!==null}update(e,t){const s=this.items_[_(t)],i=[s.minX,s.minY,s.maxX,s.maxY];P(i,e)||(this.remove(t),this.insert(e,t))}getAll(){return this.rbush_.all().map(function(t){return t.value})}getInExtent(e){const t={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]};return this.rbush_.search(t).map(function(i){return i.value})}forEach(e){return this.forEach_(this.getAll(),e)}forEachInExtent(e,t){return this.forEach_(this.getInExtent(e),t)}forEach_(e,t){let s;for(let i=0,r=e.length;i<r;i++)if(s=t(e[i]),s)return s;return s}isEmpty(){return C(this.items_)}clear(){this.rbush_.clear(),this.items_={}}getExtent(e){const t=this.rbush_.toJSON();return j(t.minX,t.minY,t.maxX,t.maxY,e)}concat(e){this.rbush_.load(e.rbush_.all());for(const t in e.items_)this.items_[t]=e.items_[t]}}const d={ADDFEATURE:"addfeature",CHANGEFEATURE:"changefeature",CLEAR:"clear",REMOVEFEATURE:"removefeature",FEATURESLOADSTART:"featuresloadstart",FEATURESLOADEND:"featuresloadend",FEATURESLOADERROR:"featuresloaderror"};class m extends V{constructor(e,t,s){super(e),this.feature=t,this.features=s}}class Re extends he{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:!0,projection:void 0,state:"ready",wrapX:e.wrapX!==void 0?e.wrapX:!0}),this.on,this.once,this.un,this.loader_=Y,this.format_=e.format||null,this.overlaps_=e.overlaps===void 0?!0:e.overlaps,this.url_=e.url,e.loader!==void 0?this.loader_=e.loader:this.url_!==void 0&&(I(this.format_,"`format` must be set when `url` is set"),this.loader_=O(this.url_,this.format_)),this.strategy_=e.strategy!==void 0?e.strategy:de;const t=e.useSpatialIndex!==void 0?e.useSpatialIndex:!0;this.featuresRtree_=t?new w:null,this.loadedExtentsRtree_=new w,this.loadingExtentsCount_=0,this.nullGeometryFeatures_={},this.idIndex_={},this.uidIndex_={},this.featureChangeKeys_={},this.featuresCollection_=null;let s,i;Array.isArray(e.features)?i=e.features:e.features&&(s=e.features,i=s.getArray()),!t&&s===void 0&&(s=new U(i)),i!==void 0&&this.addFeaturesInternal(i),s!==void 0&&this.bindFeaturesCollection_(s)}addFeature(e){this.addFeatureInternal(e),this.changed()}addFeatureInternal(e){const t=_(e);if(!this.addToIndex_(t,e)){this.featuresCollection_&&this.featuresCollection_.remove(e);return}this.setupChangeEvents_(t,e);const s=e.getGeometry();if(s){const i=s.getExtent();this.featuresRtree_&&this.featuresRtree_.insert(i,e)}else this.nullGeometryFeatures_[t]=e;this.dispatchEvent(new m(d.ADDFEATURE,e))}setupChangeEvents_(e,t){t instanceof f||(this.featureChangeKeys_[e]=[v(t,q.CHANGE,this.handleFeatureChange_,this),v(t,M.PROPERTYCHANGE,this.handleFeatureChange_,this)])}addToIndex_(e,t){let s=!0;if(t.getId()!==void 0){const i=String(t.getId());if(!(i in this.idIndex_))this.idIndex_[i]=t;else if(t instanceof f){const r=this.idIndex_[i];r instanceof f?Array.isArray(r)?r.push(t):this.idIndex_[i]=[r,t]:s=!1}else s=!1}return s&&(I(!(e in this.uidIndex_),"The passed `feature` was already added to the source"),this.uidIndex_[e]=t),s}addFeatures(e){this.addFeaturesInternal(e),this.changed()}addFeaturesInternal(e){const t=[],s=[],i=[];for(let r=0,n=e.length;r<n;r++){const a=e[r],o=_(a);this.addToIndex_(o,a)&&s.push(a)}for(let r=0,n=s.length;r<n;r++){const a=s[r],o=_(a);this.setupChangeEvents_(o,a);const u=a.getGeometry();if(u){const h=u.getExtent();t.push(h),i.push(a)}else this.nullGeometryFeatures_[o]=a}if(this.featuresRtree_&&this.featuresRtree_.load(t,i),this.hasListener(d.ADDFEATURE))for(let r=0,n=s.length;r<n;r++)this.dispatchEvent(new m(d.ADDFEATURE,s[r]))}bindFeaturesCollection_(e){let t=!1;this.addEventListener(d.ADDFEATURE,function(s){t||(t=!0,e.push(s.feature),t=!1)}),this.addEventListener(d.REMOVEFEATURE,function(s){t||(t=!0,e.remove(s.feature),t=!1)}),e.addEventListener(A.ADD,s=>{t||(t=!0,this.addFeature(s.element),t=!1)}),e.addEventListener(A.REMOVE,s=>{t||(t=!0,this.removeFeature(s.element),t=!1)}),this.featuresCollection_=e}clear(e){if(e){for(const s in this.featureChangeKeys_)this.featureChangeKeys_[s].forEach(T);this.featuresCollection_||(this.featureChangeKeys_={},this.idIndex_={},this.uidIndex_={})}else if(this.featuresRtree_){this.featuresRtree_.forEach(s=>{this.removeFeatureInternal(s)});for(const s in this.nullGeometryFeatures_)this.removeFeatureInternal(this.nullGeometryFeatures_[s])}this.featuresCollection_&&this.featuresCollection_.clear(),this.featuresRtree_&&this.featuresRtree_.clear(),this.nullGeometryFeatures_={};const t=new m(d.CLEAR);this.dispatchEvent(t),this.changed()}forEachFeature(e){if(this.featuresRtree_)return this.featuresRtree_.forEach(e);this.featuresCollection_&&this.featuresCollection_.forEach(e)}forEachFeatureAtCoordinateDirect(e,t){const s=[e[0],e[1],e[0],e[1]];return this.forEachFeatureInExtent(s,function(i){const r=i.getGeometry();if(r instanceof f||r.intersectsCoordinate(e))return t(i)})}forEachFeatureInExtent(e,t){if(this.featuresRtree_)return this.featuresRtree_.forEachInExtent(e,t);this.featuresCollection_&&this.featuresCollection_.forEach(t)}forEachFeatureIntersectingExtent(e,t){return this.forEachFeatureInExtent(e,function(s){const i=s.getGeometry();if(i instanceof f||i.intersectsExtent(e)){const r=t(s);if(r)return r}})}getFeaturesCollection(){return this.featuresCollection_}getFeatures(){let e;return this.featuresCollection_?e=this.featuresCollection_.getArray().slice(0):this.featuresRtree_&&(e=this.featuresRtree_.getAll(),C(this.nullGeometryFeatures_)||L(e,Object.values(this.nullGeometryFeatures_))),e}getFeaturesAtCoordinate(e){const t=[];return this.forEachFeatureAtCoordinateDirect(e,function(s){t.push(s)}),t}getFeaturesInExtent(e,t){if(this.featuresRtree_){if(!(t&&t.canWrapX()&&this.getWrapX()))return this.featuresRtree_.getInExtent(e);const i=z(e,t);return[].concat(...i.map(r=>this.featuresRtree_.getInExtent(r)))}return this.featuresCollection_?this.featuresCollection_.getArray().slice(0):[]}getClosestFeatureToCoordinate(e,t){const s=e[0],i=e[1];let r=null;const n=[NaN,NaN];let a=1/0;const o=[-1/0,-1/0,1/0,1/0];return t=t||K,this.featuresRtree_.forEachInExtent(o,function(u){if(t(u)){const h=u.getGeometry(),E=a;if(a=h instanceof f?0:h.closestPointXY(s,i,n,a),a<E){r=u;const c=Math.sqrt(a);o[0]=s-c,o[1]=i-c,o[2]=s+c,o[3]=i+c}}}),r}getExtent(e){return this.featuresRtree_.getExtent(e)}getFeatureById(e){const t=this.idIndex_[e.toString()];return t!==void 0?t:null}getFeatureByUid(e){const t=this.uidIndex_[e];return t!==void 0?t:null}getFormat(){return this.format_}getOverlaps(){return this.overlaps_}getUrl(){return this.url_}handleFeatureChange_(e){const t=e.target,s=_(t),i=t.getGeometry();if(!i)s in this.nullGeometryFeatures_||(this.featuresRtree_&&this.featuresRtree_.remove(t),this.nullGeometryFeatures_[s]=t);else{const n=i.getExtent();s in this.nullGeometryFeatures_?(delete this.nullGeometryFeatures_[s],this.featuresRtree_&&this.featuresRtree_.insert(n,t)):this.featuresRtree_&&this.featuresRtree_.update(n,t)}const r=t.getId();if(r!==void 0){const n=r.toString();this.idIndex_[n]!==t&&(this.removeFromIdIndex_(t),this.idIndex_[n]=t)}else this.removeFromIdIndex_(t),this.uidIndex_[s]=t;this.changed(),this.dispatchEvent(new m(d.CHANGEFEATURE,t))}hasFeature(e){const t=e.getId();return t!==void 0?t in this.idIndex_:_(e)in this.uidIndex_}isEmpty(){return this.featuresRtree_?this.featuresRtree_.isEmpty()&&C(this.nullGeometryFeatures_):this.featuresCollection_?this.featuresCollection_.getLength()===0:!0}loadFeatures(e,t,s){const i=this.loadedExtentsRtree_,r=this.strategy_(e,t,s);for(let n=0,a=r.length;n<a;++n){const o=r[n];i.forEachInExtent(o,function(h){return J(h.extent,o)})||(++this.loadingExtentsCount_,this.dispatchEvent(new m(d.FEATURESLOADSTART)),this.loader_.call(this,o,t,s,h=>{--this.loadingExtentsCount_,this.dispatchEvent(new m(d.FEATURESLOADEND,void 0,h))},()=>{--this.loadingExtentsCount_,this.dispatchEvent(new m(d.FEATURESLOADERROR))}),i.insert(o,{extent:o.slice()}))}this.loading=this.loader_.length<4?!1:this.loadingExtentsCount_>0}refresh(){this.clear(!0),this.loadedExtentsRtree_.clear(),super.refresh()}removeLoadedExtent(e){const t=this.loadedExtentsRtree_,s=t.forEachInExtent(e,function(i){if(P(i.extent,e))return i});s&&t.remove(s)}removeFeatures(e){let t=!1;for(let s=0,i=e.length;s<i;++s)t=this.removeFeatureInternal(e[s])||t;t&&this.changed()}removeFeature(e){if(!e)return;this.removeFeatureInternal(e)&&this.changed()}removeFeatureInternal(e){const t=_(e);if(!(t in this.uidIndex_))return!1;t in this.nullGeometryFeatures_?delete this.nullGeometryFeatures_[t]:this.featuresRtree_&&this.featuresRtree_.remove(e);const s=this.featureChangeKeys_[t];s==null||s.forEach(T),delete this.featureChangeKeys_[t];const i=e.getId();if(i!==void 0){const r=i.toString(),n=this.idIndex_[r];n===e?delete this.idIndex_[r]:Array.isArray(n)&&(n.splice(n.indexOf(e),1),n.length===1&&(this.idIndex_[r]=n[0]))}return delete this.uidIndex_[t],this.hasListener(d.REMOVEFEATURE)&&this.dispatchEvent(new m(d.REMOVEFEATURE,e)),!0}removeFromIdIndex_(e){for(const t in this.idIndex_)if(this.idIndex_[t]===e){delete this.idIndex_[t];break}}setLoader(e){this.loader_=e}setUrl(e){I(this.format_,"`format` must be set when `url` is set"),this.url_=e,this.setLoader(O(e,this.format_))}setOverlaps(e){this.overlaps_=e,this.changed()}}export{m as VectorSourceEvent,Re as default};
