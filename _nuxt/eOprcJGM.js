import{T as xe,a as Re,c as he,I as we,R as me,g as Ee}from"./A64qX3LD.js";import{T as y}from"./DENk7BAX.js";import{D as Ce,g as A,d as ve}from"./CBsAYBMq.js";import{j as Se,k as Ie,l as Le,m as J,g as ee,n as Oe,o as Ke,e as De}from"./1jRA9jIJ.js";import{t as Pe}from"./DSor2vHC.js";import{a as Q}from"./NcfOxGOJ.js";import{b as de,c as ze}from"./C3jLKcSw.js";import{C as Me}from"./CviRnRtU.js";import{L as je}from"./C1H55nfk.js";import"./DGB6o809.js";import"./DCo6-o3V.js";import"./BNCPP-Lc.js";import"./Ba_gg6Bw.js";import"./DYcbPNs3.js";import"./BBoprNr9.js";import"./Db2rOhY5.js";import"./BAiuiMj1.js";import"./CiY_2Xgg.js";import"./Cc173s93.js";function te(h){return h instanceof Image||h instanceof HTMLCanvasElement||h instanceof HTMLVideoElement||h instanceof ImageBitmap?h:null}const Ae=new Error("disposed"),ke=[256,256];class ue extends xe{constructor(e){const t=y.IDLE;super(e.tileCoord,t,{transition:e.transition,interpolate:e.interpolate}),this.loader_=e.loader,this.data_=null,this.error_=null,this.size_=e.size||null,this.controller_=e.controller||null}getSize(){if(this.size_)return this.size_;const e=te(this.data_);return e?[e.width,e.height]:ke}getData(){return this.data_}getError(){return this.error_}load(){if(this.state!==y.IDLE&&this.state!==y.ERROR)return;this.state=y.LOADING,this.changed();const e=this;this.loader_().then(function(t){e.data_=t,e.state=y.LOADED,e.changed()}).catch(function(t){e.error_=t,e.state=y.ERROR,e.changed()})}disposeInternal(){this.controller_&&(this.controller_.abort(Ae),this.controller_=null),super.disposeInternal()}}class Fe{constructor(e){this.highWaterMark=e!==void 0?e:2048,this.count_=0,this.entries_={},this.oldest_=null,this.newest_=null}deleteOldest(){const e=this.pop();e instanceof Ce&&e.dispose()}canExpireCache(){return this.highWaterMark>0&&this.getCount()>this.highWaterMark}expireCache(e){for(;this.canExpireCache();)this.deleteOldest()}clear(){for(;this.oldest_;)this.deleteOldest()}containsKey(e){return this.entries_.hasOwnProperty(e)}forEach(e){let t=this.oldest_;for(;t;)e(t.value_,t.key_,this),t=t.newer}get(e,t){const i=this.entries_[e];return Q(i!==void 0,"Tried to get a value for a key that does not exist in the cache"),i===this.newest_||(i===this.oldest_?(this.oldest_=this.oldest_.newer,this.oldest_.older=null):(i.newer.older=i.older,i.older.newer=i.newer),i.newer=null,i.older=this.newest_,this.newest_.newer=i,this.newest_=i),i.value_}remove(e){const t=this.entries_[e];return Q(t!==void 0,"Tried to get a value for a key that does not exist in the cache"),t===this.newest_?(this.newest_=t.older,this.newest_&&(this.newest_.newer=null)):t===this.oldest_?(this.oldest_=t.newer,this.oldest_&&(this.oldest_.older=null)):(t.newer.older=t.older,t.older.newer=t.newer),delete this.entries_[e],--this.count_,t.value_}getCount(){return this.count_}getKeys(){const e=new Array(this.count_);let t=0,i;for(i=this.newest_;i;i=i.older)e[t++]=i.key_;return e}getValues(){const e=new Array(this.count_);let t=0,i;for(i=this.newest_;i;i=i.older)e[t++]=i.value_;return e}peekLast(){return this.oldest_.value_}peekLastKey(){return this.oldest_.key_}peekFirstKey(){return this.newest_.key_}peek(e){var t;return(t=this.entries_[e])==null?void 0:t.value_}pop(){const e=this.oldest_;return delete this.entries_[e.key_],e.newer&&(e.newer.older=null),this.oldest_=e.newer,this.oldest_||(this.newest_=null),--this.count_,e.value_}replace(e,t){this.get(e),this.entries_[e].value_=t}set(e,t){Q(!(e in this.entries_),"Tried to set a value for a key that is used already");const i={key_:e,newer:null,older:this.newest_,value_:t};this.newest_?this.newest_.newer=i:this.oldest_=i,this.newest_=i,this.entries_[e]=i,++this.count_}setSize(e){this.highWaterMark=e}}function H(h,e,t,i){return`${h},${Ee(e,t,i)}`}function $(h,e,t){if(!(t in h))return h[t]=new Set([e]),!0;const i=h[t],s=i.has(e);return s||i.add(e),!s}function Ze(h,e,t){const i=h[t];return i?i.delete(e):!1}function ge(h,e){const t=h.layerStatesArray[h.layerIndex];t.extent&&(e=ee(e,J(t.extent,h.viewState.projection)));const i=t.layer.getRenderSource();if(!i.getWrapX()){const s=i.getTileGridForProjection(h.viewState.projection).getExtent();s&&(e=ee(e,s))}return e}class be extends Me{constructor(e,t){super(e),t=t||{},this.extentChanged=!0,this.renderComplete=!1,this.renderedExtent_=null,this.renderedPixelRatio,this.renderedProjection=null,this.renderedRevision_,this.renderedTiles=[],this.renderedSourceKey_,this.renderedSourceRevision_,this.tempExtent=Se(),this.tempTileRange_=new Re(0,0,0,0),this.tempTileCoord_=he(0,0,0);const i=t.cacheSize!==void 0?t.cacheSize:512;this.tileCache_=new Fe(i),this.maxStaleKeys=i*.5}getTileCache(){return this.tileCache_}getOrCreateTile(e,t,i,s){const o=this.tileCache_,l=this.getLayer().getSource(),c=H(l.getKey(),e,t,i);let r;if(o.containsKey(c))r=o.get(c);else{if(r=l.getTile(e,t,i,s.pixelRatio,s.viewState.projection),!r)return null;o.set(c,r)}return r}getTile(e,t,i,s){const o=this.getOrCreateTile(e,t,i,s);return o||null}getData(e){const t=this.frameState;if(!t)return null;const i=this.getLayer(),s=de(t.pixelToCoordinateTransform,e.slice()),o=i.getExtent();if(o&&!Ie(o,s))return null;const g=t.viewState,l=i.getRenderSource(),c=l.getTileGridForProjection(g.projection),r=l.getTilePixelRatio(t.pixelRatio);for(let n=c.getZForResolution(g.resolution);n>=c.getMinZoom();--n){const d=c.getTileCoordForCoordAndZ(s,n),a=this.getTile(n,d[1],d[2],t);if(!a||a.getState()!==y.LOADED)continue;const _=c.getOrigin(n),f=Pe(c.getTileSize(n)),v=c.getResolution(n);let u;if(a instanceof we||a instanceof me)u=a.getImage();else if(a instanceof ue){if(u=te(a.getData()),!u)continue}else continue;const E=Math.floor(r*((s[0]-_[0])/v-d[1]*f[0])),D=Math.floor(r*((_[1]-s[1])/v-d[2]*f[1])),m=Math.round(r*l.getGutterForProjection(g.projection));return this.getImageData(u,E+m,D+m)}return null}prepareFrame(e){this.renderedProjection?e.viewState.projection!==this.renderedProjection&&(this.tileCache_.clear(),this.renderedProjection=e.viewState.projection):this.renderedProjection=e.viewState.projection;const t=this.getLayer().getSource();if(!t)return!1;const i=t.getRevision();return this.renderedRevision_?this.renderedRevision_!==i&&(this.renderedRevision_=i,this.renderedSourceKey_===t.getKey()&&this.tileCache_.clear()):this.renderedRevision_=i,!0}enqueueTiles(e,t,i,s,o){const g=e.viewState,l=this.getLayer(),c=l.getRenderSource(),r=c.getTileGridForProjection(g.projection),n=A(c);n in e.wantedTiles||(e.wantedTiles[n]={});const d=e.wantedTiles[n],a=l.getMapInternal(),_=Math.max(i-o,r.getMinZoom(),r.getZForResolution(Math.min(l.getMaxResolution(),a?a.getView().getResolutionForZoom(Math.max(l.getMinZoom(),0)):r.getResolution(0)),c.zDirection)),f=g.rotation,v=f?Le(g.center,g.resolution,f,e.size):void 0;for(let u=i;u>=_;--u){const E=r.getTileRangeForExtentAndZ(t,u,this.tempTileRange_),D=r.getResolution(u);for(let m=E.minX;m<=E.maxX;++m)for(let S=E.minY;S<=E.maxY;++S){if(f&&!r.tileCoordIntersectsViewport([u,m,S],v))continue;const I=this.getTile(u,m,S,e);if(!I||!$(s,I,u))continue;const T=I.getKey();if(d[T]=!0,I.getState()===y.IDLE&&!e.tileQueue.isKeyQueued(T)){const k=he(u,m,S,this.tempTileCoord_);e.tileQueue.enqueue([I,n,r.getTileCoordCenter(k),D])}}}}findStaleTile_(e,t){const i=this.tileCache_,s=e[0],o=e[1],g=e[2],l=this.getStaleKeys();for(let c=0;c<l.length;++c){const r=H(l[c],s,o,g);if(i.containsKey(r)){const n=i.peek(r);if(n.getState()===y.LOADED)return n.endTransition(A(this)),$(t,n,s),!0}}return!1}findAltTiles_(e,t,i,s){const o=e.getTileRangeForTileCoordAndZ(t,i,this.tempTileRange_);if(!o)return!1;let g=!0;const l=this.tileCache_,r=this.getLayer().getRenderSource().getKey();for(let n=o.minX;n<=o.maxX;++n)for(let d=o.minY;d<=o.maxY;++d){const a=H(r,i,n,d);let _=!1;if(l.containsKey(a)){const f=l.peek(a);f.getState()===y.LOADED&&($(s,f,i),_=!0)}_||(g=!1)}return g}renderFrame(e,t){this.renderComplete=!0;const i=e.layerStatesArray[e.layerIndex],s=e.viewState,o=s.projection,g=s.resolution,l=s.center,c=e.pixelRatio,r=this.getLayer(),n=r.getSource(),d=n.getTileGridForProjection(o),a=d.getZForResolution(g,n.zDirection),_=d.getResolution(a),f=n.getKey();this.renderedSourceKey_?this.renderedSourceKey_!==f&&(this.prependStaleKey(this.renderedSourceKey_),this.renderedSourceKey_=f):this.renderedSourceKey_=f;let v=e.extent;const u=n.getTilePixelRatio(c);this.prepareContainer(e,t);const E=this.context.canvas.width,D=this.context.canvas.height,m=i.extent&&J(i.extent,o);m&&(v=ee(v,J(i.extent,o)));const S=_*E/2/u,I=_*D/2/u,z=[l[0]-S,l[1]-I,l[0]+S,l[1]+I],T={};this.renderedTiles.length=0;const k=r.getPreload();if(e.nextExtent){const x=d.getZForResolution(s.nextResolution,n.zDirection),R=ge(e,e.nextExtent);this.enqueueTiles(e,R,x,T,k)}const ie=ge(e,v);if(this.enqueueTiles(e,ie,a,T,0),k>0&&setTimeout(()=>{this.enqueueTiles(e,ie,a-1,T,k-1)},0),!(a in T))return this.container;const ne=A(this),_e=e.time;for(const x of T[a]){const R=x.getState();if(R===y.EMPTY)continue;const L=x.tileCoord;if(R===y.LOADED&&x.getAlpha(ne,_e)===1){x.endTransition(ne);continue}if(R!==y.ERROR&&(this.renderComplete=!1),this.findStaleTile_(L,T)){Ze(T,x,a),e.animate=!0;continue}if(this.findAltTiles_(d,L,a+1,T))continue;const j=d.getMinZoom();for(let P=a-1;P>=j&&!this.findAltTiles_(d,L,P,T);--P);}const Z=_/g*c/u,p=this.getRenderContext(e);ze(this.tempTransform,E/2,D/2,Z,Z,0,-E/2,-D/2),i.extent&&this.clipUnrotated(p,e,m),n.getInterpolate()||(p.imageSmoothingEnabled=!1),this.preRender(p,e);const b=Object.keys(T).map(Number);b.sort(ve);let C;const W=[],se=[];for(let x=b.length-1;x>=0;--x){const R=b[x],L=n.getTilePixelSize(R,c,o),M=d.getResolution(R)/_,j=L[0]*M*Z,P=L[1]*M*Z,U=d.getTileCoordForCoordAndZ(Oe(z),R),re=d.getTileCoordExtent(U),G=de(this.tempTransform,[u*(re[0]-z[0])/_,u*(z[3]-re[3])/_]),pe=u*n.getGutterForProjection(o);for(const F of T[R]){if(F.getState()!==y.LOADED)continue;const oe=F.tileCoord,le=U[1]-oe[1],fe=Math.round(G[0]-(le-1)*j),ce=U[2]-oe[2],Te=Math.round(G[1]-(ce-1)*P),O=Math.round(G[0]-le*j),K=Math.round(G[1]-ce*P),N=fe-O,X=Te-K,ae=b.length===1;let V=!1;C=[O,K,O+N,K,O+N,K+X,O,K+X];for(let Y=0,ye=W.length;Y<ye;++Y)if(!ae&&R<se[Y]){const w=W[Y];Ke([O,K,O+N,K+X],[w[0],w[3],w[4],w[7]])&&(V||(p.save(),V=!0),p.beginPath(),p.moveTo(C[0],C[1]),p.lineTo(C[2],C[3]),p.lineTo(C[4],C[5]),p.lineTo(C[6],C[7]),p.moveTo(w[6],w[7]),p.lineTo(w[4],w[5]),p.lineTo(w[2],w[3]),p.lineTo(w[0],w[1]),p.clip())}W.push(C),se.push(R),this.drawTile(F,e,O,K,N,X,pe,ae),V&&p.restore(),this.renderedTiles.unshift(F),this.updateUsedTiles(e.usedTiles,n,F)}}if(this.renderedResolution=_,this.extentChanged=!this.renderedExtent_||!De(this.renderedExtent_,z),this.renderedExtent_=z,this.renderedPixelRatio=c,this.postRender(this.context,e),i.extent&&p.restore(),p.imageSmoothingEnabled=!0,this.renderComplete){const x=(R,L)=>{const B=A(n),M=L.wantedTiles[B],j=M?Object.keys(M).length:0;this.updateCacheSize(j),this.tileCache_.expireCache()};e.postRenderFunctions.push(x)}return this.container}updateCacheSize(e){this.tileCache_.highWaterMark=Math.max(this.tileCache_.highWaterMark,e*2)}drawTile(e,t,i,s,o,g,l,c){let r;if(e instanceof ue){if(r=te(e.getData()),!r)throw new Error("Rendering array data is not yet supported")}else r=this.getTileImage(e);if(!r)return;const n=this.getRenderContext(t),d=A(this),a=t.layerStatesArray[t.layerIndex],_=a.opacity*(c?e.getAlpha(d,t.time):1),f=_!==n.globalAlpha;f&&(n.save(),n.globalAlpha=_),n.drawImage(r,l,l,r.width-2*l,r.height-2*l,i,s,o,g),f&&n.restore(),_!==a.opacity?t.animate=!0:c&&e.endTransition(d)}getImage(){const e=this.context;return e?e.canvas:null}getTileImage(e){return e.getImage()}updateUsedTiles(e,t,i){const s=A(t);s in e||(e[s]={}),e[s][i.getKey()]=!0}}const q={PRELOAD:"preload",USE_INTERIM_TILES_ON_ERROR:"useInterimTilesOnError"};class Ue extends je{constructor(e){e=e||{};const t=Object.assign({},e),i=e.cacheSize;delete e.cacheSize,delete t.preload,delete t.useInterimTilesOnError,super(t),this.on,this.once,this.un,this.cacheSize_=i,this.setPreload(e.preload!==void 0?e.preload:0),this.setUseInterimTilesOnError(e.useInterimTilesOnError!==void 0?e.useInterimTilesOnError:!0)}getCacheSize(){return this.cacheSize_}getPreload(){return this.get(q.PRELOAD)}setPreload(e){this.set(q.PRELOAD,e)}getUseInterimTilesOnError(){return this.get(q.USE_INTERIM_TILES_ON_ERROR)}setUseInterimTilesOnError(e){this.set(q.USE_INTERIM_TILES_ON_ERROR,e)}getData(e){return super.getData(e)}}class lt extends Ue{constructor(e){super(e)}createRenderer(){return new be(this,{cacheSize:this.getCacheSize()})}}export{lt as default};
